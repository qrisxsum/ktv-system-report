# KTV 多门店报表自动化系统 - 开发框架指南 (Lite版)

## 文档说明

本文档基于《具体需求.md》《字段映射.md》《解析与清洗.md》《入库模型.md》《聚合.md》《web界面.md》六个核心文档，制定**简化版**的系统开发规划。

**核心理念**：从“分布式微服务”转向**“模块化单体”**。在满足核心需求的前提下，大幅降低工程复杂度，提高开发效率。

**版本号**: v2.2 (Lite - Physical Aligned)  
**生成日期**: 2025-12-10  
**目标**: 构建一个单体、易部署、响应快的 Web 报表系统。

---

## 一、文档与开发阶段对应关系

### 1.1 六个文档对应的开发阶段

| 文档名称 | 开发阶段 | 核心内容 | 优先级 |
|---|---|---|---|
| 具体需求.md | 需求分析 | 业务需求、数据规范、功能范围 | P0 |
| 入库模型.md | 数据库设计 | 表结构设计（MySQL 核心列 + JSON 扩展）、索引优化 | P0 |
| 字段映射.md | 数据准备 | 字段映射表、数据质量统计 | P0 |
| 解析与清洗.md | 数据处理 | **多级表头合并**、**动态列 JSON 归集**、内存清洗 | P0 |
| 聚合.md | 数据分析 | 实时 SQL 聚合、赠送与成本分析 | P1 |
| web界面.md | 数据展示 | Vue3前端、ECharts展示、简单鉴权 | P1 |

### 1.2 数据流转架构 (Lite)

```mermaid
graph LR
    A[原始文件 (Excel/CSV)] --> B[Pandas 读取 & Flatten]
    B --> C[内存清洗 & 映射 (JSON Pack)]
    C --> D[校验 & 转换]
    D --> E[MySQL (事实表/维度表)]
    E --> F[SQLAlchemy 实时查询]
    F --> G[FastAPI (JSON Response)]
    G --> H[Vue3 前端展示]
```

---

## 二、开发顺序规划 (3周冲刺)

### 2.1 第一阶段：原型核心 (Week 1)

**目标**：搭建 FastAPI + SQLAlchemy 基础骨架，打通“上传 -> 解析 -> 入库 -> 简单查询”全流程。

**任务清单**：
- [ ] **项目骨架搭建**
    - [ ] 按照 3.1 节规范完善 `backend` 目录结构
    - [ ] 配置 FastAPI 应用与 SQLAlchemy 数据库连接 (Core)
    - [ ] 配置 Alembic 迁移环境
- [ ] **数据库设计与实现**
    - [ ] 定义核心模型：`MetaFileBatch` (批次), `DimStore`, `FactBooking` (预订事实表), `FactSales` (酒水表含赠送)
    - [ ] 生成并执行 Alembic 迁移脚本
- [ ] **ETL 核心链路**
    - [ ] 实现 `ParserService`：**合并多级表头**，处理 Excel 格式
    - [ ] 实现 `CleanerService`：**动态归集 extra_payments**，计算实收金额
    - [ ] 实现 `ImporterService`：基于 `batch_id` 的覆盖写入
    - [ ] 实现 `StatsService`：封装基础聚合查询逻辑
    - [ ] 实现 FastAPI 后台任务 (BackgroundTasks) 处理上传文件
- [ ] **基础 API**
    - [ ] 文件上传接口 (返回包含平衡性校验的 summary)
    - [ ] 简单的按日/按门店聚合查询接口 (基于 StatsService)

**交付物**：
- 可运行的后端服务
- 预订表和酒水表数据成功入库（含 JSON 字段）
- 基础查询 API 可用

### 2.2 第二阶段：完整 ETL 与 Web 框架 (Week 2)

**目标**：扩展支持所有业务表，搭建 Vue3 前端，实现前后端联调。

**任务清单**：
- [ ] **ETL 扩展**
    - [ ] 扩展模型：`FactRoom` (包厢), `DimEmployee`, `DimProduct`
    - [ ] 完善清洗逻辑：增加数据校验（如金额平衡）、异常处理
    - [ ] 实现全量表的解析与入库逻辑
- [ ] **前端骨架搭建**
    - [ ] 初始化 Vue 3 + Vite + Element Plus 项目 (已完成)
    - [ ] 配置 Axios 拦截器与基础路由
    - [ ] 开发布局组件 (Layout)
- [ ] **核心功能联调**
    - [ ] **文件上传界面**：支持拖拽上传，显示详细的校验反馈
    - [ ] **数据查询界面**：实现动态表格展示，支持成本与赠送列
- [ ] **批次管理**
    - [ ] 实现批次列表、批次详情查看
    - [ ] 实现批次删除（回滚数据）功能

**交付物**：
- 完整的数据入库能力
- 前端可进行文件上传和查看状态
- 批次管理功能可用

### 2.3 第三阶段：可视化与完善 (Week 3)

**目标**：实现数据可视化，导出功能，以及系统完善。

**任务清单**：
- [ ] **数据可视化**
    - [ ] 集成 ECharts
    - [ ] 开发核心指标看板 (Dashboard)：实收、毛利率、**赠送率**
- [ ] **高级查询与导出**
    - [ ] 完善通用查询接口 (支持 group_by, date_range)
    - [ ] 实现 CSV 流式导出功能
- [ ] **系统完善**
    - [ ] **简单鉴权**：实现基于 Cookie/Session 的登录机制
    - [ ] **部署准备**：配置 FastAPI 托管前端静态资源
    - [ ] **性能优化**：添加必要的数据库索引
- [ ] **测试与交付**
    - [ ] 编写核心业务逻辑测试
    - [ ] 编写用户操作手册

**交付物**：
- 功能完整的 Web 报表系统
- 可视化看板
- 数据导出功能
- 部署文档

---

## 三、项目目录结构 (实际物理结构)

基于 Docker Compose 的前后端分离目录结构，但在逻辑上保持模块化。

```text
ktv-system-report/
├── backend/                # 后端根目录
│   ├── app/
│   │   ├── api/            # API 路由
│   │   │   ├── __init__.py
│   │   │   ├── auth.py     # 登录认证
│   │   │   ├── upload.py   # 文件上传与批次
│   │   │   └── stats.py    # 数据统计与查询
│   │   ├── core/           # 核心配置
│   │   │   ├── config.py   # 环境变量配置 (Pydantic)
│   │   │   └── database.py # 数据库连接会话
│   │   ├── models/         # 数据库模型 (ORM)
│   │   │   ├── __init__.py
│   │   │   ├── base.py
│   │   │   ├── meta.py     # 批次、日志等元数据
│   │   │   ├── dims.py     # 门店、员工、商品、包厢等维度
│   │   │   └── facts.py    # 预订、房台、销售事实表
│   │   ├── services/       # 业务逻辑 (ETL核心)
│   │   │   ├── __init__.py
│   │   │   ├── parser.py   # 文件读取与解析
│   │   │   ├── cleaner.py  # 清洗与映射逻辑
│   │   │   ├── importer.py # 入库逻辑
│   │   │   └── stats.py    # 聚合统计逻辑
│   │   ├── __init__.py
│   │   └── main.py         # FastAPI 启动入口
│   ├── alembic/            # 数据库迁移脚本
│   ├── Dockerfile          # 后端构建文件
│   └── requirements.txt    # Python 依赖
├── frontend/               # 前端根目录 (Vue3 + Vite)
│   ├── src/
│   ├── Dockerfile
│   └── ...
├── data/                   # 数据持久化目录
│   ├── uploads/            # 上传文件存储
│   └── mysql/              # 数据库文件映射
├── docker/                 # Docker 配置
│   └── mysql/              # MySQL 初始化脚本与配置
├── docs/                   # 项目文档
├── docker-compose.yml      # 容器编排
└── README.md
```

---

## 四、技术栈选择 (精简版)

### 4.1 后端技术栈

| 模块 | 技术 | 说明 |
|---|---|---|
| **语言** | Python 3.11 | 基于 Docker 镜像版本 |
| **Web框架** | **FastAPI** | 高性能，易于开发 |
| **数据库** | **MySQL 8.0** | 移除分区/物化视图，利用索引优化 |
| **ORM** | **SQLAlchemy** | 异步/同步模式均可，推荐 2.0+ |
| **迁移** | **Alembic** | 数据库版本控制 |
| **数据处理** | **Pandas** | 核心 ETL 工具，处理解析、清洗 |
| **异步任务** | **BackgroundTasks** | FastAPI 自带，用于文件导入，替代 Celery |
| **认证** | **Cookie/Session** | 替代复杂的 JWT，基于 Session 的简单认证 |
| **Excel解析** | **openpyxl / pandas** | pandas用于表格读取 |

### 4.2 前端技术栈

| 模块 | 技术 | 说明 |
|---|---|---|
| **框架** | **Vue 3** | 组合式 API (Composition API) |
| **构建** | **Vite** | 极速构建 |
| **UI库** | **Element Plus** | 成熟的企业级组件库 |
| **图表** | **ECharts** | 数据可视化 (含赠送率等分析) |
| **HTTP** | **Axios** | |

---

## 五、开发环境配置

### 5.1 Python 环境 (本地调试用)

```bash
# 进入 backend 目录
cd backend
# 创建虚拟环境
python -m venv venv
# 激活 (Windows)
venv\Scripts\activate
# 安装依赖
pip install -r requirements.txt
```

### 5.2 数据库与环境配置

项目优先读取环境变量（Environment Variables），开发模式下通过 `docker-compose.yml` 自动注入。

**核心配置项 (对应 `backend/app/core/config.py`)**:

```python
# 伪代码示例
class Settings(BaseSettings):
    # Database
    DB_HOST: str = "mysql"  # Docker 服务名，本地直连可改为 localhost
    DB_PORT: int = 3306
    DB_USER: str = "ktv_user"
    DB_PASSWORD: str = "ktv123456"
    DB_NAME: str = "ktv_report"

    # Security
    SECRET_KEY: str = "your-secret-key"
    
    # Storage
    UPLOAD_DIR: str = "/app/data/uploads"  # 容器内挂载路径
```

**docker-compose.yml 环境变量映射**:
确保 `docker-compose.yml` 中的 `backend` 服务包含上述变量配置。

---

## 六、开发规范

### 6.1 代码规范
- **Python**: 遵循 PEP 8，使用 Type Hints (但避免滥用 `Any`)。
- **Vue**: 使用 `<script setup>` 语法糖，组件名大驼峰。

### 6.2 命名约定
- **数据库表**: `meta_file_batch`, `dim_store`, `fact_booking` (小写下划线)
- **API 路径**: `/api/v1/upload`, `/api/v1/stats/query`
- **前端组件**: `FileUpload.vue`, `SalesChart.vue`

---

## 七、测试策略

重点关注**集成测试**和**关键逻辑单元测试**。

1.  **单元测试**:
    - `cleaner.py`: 测试金额格式化、日期转换、**JSON 字段归集逻辑**。
    - `parser.py`: 测试**多级表头合并**的正确性。
2.  **集成测试**:
    - **导入流程**: 上传文件 -> 触发任务 -> 检查数据库记录 (含 JSON) -> 检查批次状态。
    - **查询流程**: 构造测试数据 -> 调用查询 API -> 验证聚合结果准确性 (含赠送与成本)。

---

## 八、部署方案

采用**单进程/单容器**部署模式，极大简化运维。

### 8.1 架构 (生产环境)
- **FastAPI** 作为主进程。
- **StaticFiles**: FastAPI 挂载 `/` 路径，服务 Vue 构建生成的 `index.html` 和静态资源。
- **API**: 挂载在 `/api` 路径下。

### 8.2 启动命令

```bash
# 生产环境启动
uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4
```

### 8.3 Dockerfile 示例

```dockerfile
# 见 backend/Dockerfile 中的 production 阶段
FROM python:3.11-slim as production
# ...
COPY --from=frontend_build /app/dist /app/static
# ...
```

---

## 九、风险与应对 (Lite版)

1.  **大文件处理阻塞**:
    - **应对**: 虽然移除了 Celery，但 `BackgroundTasks` 仍是在事件循环中执行。对于超大文件（>50MB），pandas 处理可能会阻塞主线程。
    - **解决**: 使用 `run_in_threadpool` 或简单的 `ThreadPoolExecutor` 将 pandas 操作放入线程池执行。
2.  **内存占用**:
    - **应对**: Pandas 全量读取可能会消耗大量内存。
    - **解决**: 预留足够的服务器内存（建议 4GB+），或在读取时使用 `chunksize` 分块处理。
3.  **单点故障**:
    - **应对**: 单体架构下，服务挂掉会导致全站不可用。
    - **解决**: 配置 Docker Restart 策略 (`restart: always`) 或使用 Supervisor 守护进程。

---

## 十、总结

本指南通过**做减法**，将原本复杂的企业级架构精简为适合当前阶段的**敏捷开发架构**。
- **去掉**了非必要的分布式组件 (Redis, Celery)。
- **去掉**了复杂的中间层 (DTO, Layered Architecture)。
- **保留**了最核心的数据价值流 (Pandas ETL -> MySQL -> Visualization)。

开发团队应聚焦于**业务逻辑的准确性**（数据清洗、口径计算），而非架构的复杂性。
