# KTV 多门店报表自动化系统 - 开发框架指南

## 文档说明

本文档基于《具体需求.md》《字段映射.md》《解析与清洗.md》《入库模型.md》《聚合.md》《web界面.md》六个核心文档，制定系统化的开发规划，包括开发顺序、项目目录结构、技术栈选择、依赖关系等核心内容。

**版本号**: v1.0  
**生成日期**: 2025-12-03  
**目标**: 为项目开发提供清晰的路线图和实施指南

---

## 一、文档与开发阶段对应关系

### 1.1 六个文档对应的开发阶段

| 文档名称 | 开发阶段 | 核心内容 | 优先级 |
|---------|---------|---------|--------|
| 具体需求.md | 需求分析阶段 | 业务需求、数据规范、功能范围 | P0 |
| 入库模型.md | 数据库设计阶段 | 表结构设计、主键策略、分区方案、索引设计 | P0 |
| 字段映射.md | 数据准备阶段 | 字段映射表、数据质量统计、校验规则 | P0 |
| 解析与清洗.md | 数据处理阶段 | 文件解析、数据清洗、校验、幂等性 | P0 |
| 聚合.md | 数据分析阶段 | 聚合计算、口径函数、宽表设计、校验报告 | P1 |
| web界面.md | 数据展示阶段 | API设计、前端界面、权限管理、审计日志 | P1 |

### 1.2 开发阶段依赖关系

```
需求分析（具体需求.md）
    ↓
数据库设计（入库模型.md） ← 依赖：需求分析
    ↓
字段映射配置（字段映射.md） ← 依赖：数据库设计
    ↓
数据解析清洗（解析与清洗.md） ← 依赖：字段映射、数据库设计
    ↓
数据入库实现（入库模型.md实施） ← 依赖：解析清洗、数据库设计
    ↓
聚合计算（聚合.md） ← 依赖：数据入库
    ↓
Web界面（web界面.md） ← 依赖：聚合计算、数据入库
```

---

## 二、开发顺序规划

### 2.1 第一阶段：需求分析与数据库设计（Week 1-2）

**目标**：完成需求梳理和数据库设计，为后续开发奠定基础。

**任务清单**：
- [x] 需求文档梳理（具体需求.md）
- [ ] 数据库选型确认（MySQL 5.7+/8.0+）
- [ ] 数据库Schema设计（入库模型.md）
- [ ] 表结构设计（元数据表、维度表、事实表）
- [ ] 主键和索引策略设计
- [ ] 分区策略设计
- [ ] 使用Alembic创建数据库迁移脚本
- [ ] 初始化数据库和基础表结构

**交付物**：
- 数据库设计文档（入库模型.md）
- Alembic迁移脚本
- 数据库初始化脚本

**技术栈**：
- MySQL 5.7+/8.0+
- SQLAlchemy ORM
- Alembic（数据库迁移）

---

### 2.2 第二阶段：字段映射配置与初始化（Week 2-3）

**目标**：建立字段映射体系，初始化配置数据。

**任务清单**：
- [ ] 字段映射表设计（meta_field_mapping）
- [ ] 根据字段映射.md初始化三张表的字段映射数据
- [ ] 支付方式维度表初始化（dim_payment_method）
- [ ] 门店维度表初始化（dim_store）
- [ ] 时间维度表初始化（dim_date，生成未来5年数据）
- [ ] 字段映射查询接口开发（用于解析阶段）
- [ ] 字段映射管理工具开发（可选）

**交付物**：
- 字段映射配置数据
- 维度表初始化数据
- 字段映射查询服务

**技术栈**：
- Python
- SQLAlchemy
- Pandas（数据处理）

---

### 2.3 第三阶段：数据解析与清洗流水线（Week 3-5）

**目标**：实现文件解析、数据清洗、校验功能。

**任务清单**：
- [ ] 编码和分隔符探测功能
- [ ] 文件读取和标题行删除功能
- [ ] 字段映射应用功能
- [ ] 类型转换和数据标准化功能
- [ ] 行哈希和文件校验和生成功能
- [ ] 关键业务规则校验功能（平衡校验、异常检测）
- [ ] 异常处理和容错机制
- [ ] 日志记录功能
- [ ] 单元测试（解析、清洗、校验函数）

**交付物**：
- 数据解析模块（parsing/）
- 数据清洗模块（cleaning/）
- 数据校验模块（validation/）
- 单元测试用例

**技术栈**：
- Python
- Pandas（数据处理）
- chardet（编码检测）
- csv.Sniffer（分隔符检测）
- hashlib（哈希计算）

---

### 2.4 第四阶段：数据入库实现（Week 5-7）

**目标**：实现数据入库流程，支持幂等性和批次管理。

**任务清单**：
- [ ] 文件批次管理功能（meta_file_batch）
- [ ] 原始数据入库功能（raw_rows）
- [ ] 维度关联功能（门店、员工、包厢、商品）
- [ ] 事实表入库功能（fact_booking_summary、fact_room_analysis、fact_beverage_sales）
- [ ] 幂等性控制（row_hash去重）
- [ ] 批次状态管理
- [ ] 导入日志记录（meta_import_log）
- [ ] 数据导入服务封装
- [ ] 集成测试（端到端导入流程）

**交付物**：
- 数据入库模块（import/）
- 批次管理服务
- 维度关联服务
- 集成测试用例

**技术栈**：
- Python
- SQLAlchemy ORM
- Pandas（批量插入）

---

### 2.5 第五阶段：聚合计算与口径函数（Week 7-9）

**目标**：实现聚合计算、口径函数、宽表刷新功能。

**任务清单**：
- [ ] 口径计算函数实现（实收、业绩、毛利）
- [ ] 支付方式分类配置化
- [ ] 日级聚合SQL实现（按门店、员工、包厢、商品）
- [ ] 周级/月级聚合SQL实现
- [ ] TopN查询SQL实现
- [ ] 宽表设计（agg_daily_*）
- [ ] 宽表刷新逻辑实现
- [ ] 物化视图或视图实现（MySQL 8.0+）
- [ ] 聚合校验报告生成
- [ ] 性能测试和优化

**交付物**：
- 聚合计算模块（aggregations/）
- 口径函数模块（calculations/）
- 宽表刷新服务
- 聚合查询服务

**技术栈**：
- Python
- SQLAlchemy
- MySQL（窗口函数、物化视图）

---

### 2.6 第六阶段：Web界面与API开发（Week 9-12）

**目标**：实现Web界面和API，支持数据查询、可视化、导出。

**任务清单**：
- [ ] 后端API基础框架（FastAPI）
- [ ] 认证与权限系统（JWT Token）
- [ ] 文件上传接口
- [ ] 批次管理接口
- [ ] 校验报告接口
- [ ] 聚合查询接口
- [ ] 数据导出接口
- [ ] 维度数据接口
- [ ] 前端项目初始化（React/Vue）
- [ ] 登录与权限管理界面
- [ ] 文件上传界面
- [ ] 批次管理界面
- [ ] 指标看板界面
- [ ] 数据查询界面
- [ ] 校验报告界面
- [ ] 审计日志功能

**交付物**：
- 后端API服务（backend/）
- 前端Web应用（frontend/）
- API文档
- 前端组件库

**技术栈**：
- 后端：FastAPI、SQLAlchemy、JWT
- 前端：React/Vue、Ant Design/Element UI、ECharts、Axios

---

## 三、项目目录结构

### 3.1 整体项目结构

```
ktv-report-system/
├── docs/                          # 文档目录
│   ├── 具体需求.md
│   ├── 字段映射.md
│   ├── 解析与清洗.md
│   ├── 入库模型.md
│   ├── 聚合.md
│   ├── web界面.md
│   └── 开发框架指南.md
│
├── backend/                       # 后端服务
│   ├── app/
│   │   ├── __init__.py
│   │   ├── main.py                # FastAPI应用入口
│   │   ├── config.py              # 配置文件
│   │   ├── database.py            # 数据库连接
│   │   │
│   │   ├── models/                # SQLAlchemy模型
│   │   │   ├── __init__.py
│   │   │   ├── base.py            # 基础模型类
│   │   │   ├── meta.py            # 元数据表模型
│   │   │   ├── raw.py             # 原始数据表模型
│   │   │   ├── dim.py             # 维度表模型
│   │   │   └── fact.py            # 事实表模型
│   │   │
│   │   ├── schemas/               # Pydantic模型（API请求/响应）
│   │   │   ├── __init__.py
│   │   │   ├── batch.py
│   │   │   ├── file.py
│   │   │   ├── aggregation.py
│   │   │   └── auth.py
│   │   │
│   │   ├── api/                   # API路由
│   │   │   ├── __init__.py
│   │   │   ├── auth.py            # 认证相关
│   │   │   ├── files.py            # 文件上传
│   │   │   ├── batches.py         # 批次管理
│   │   │   ├── aggregations.py    # 聚合查询
│   │   │   ├── export.py          # 数据导出
│   │   │   └── dimensions.py     # 维度数据
│   │   │
│   │   ├── services/              # 业务逻辑层
│   │   │   ├── __init__.py
│   │   │   ├── file_service.py   # 文件服务
│   │   │   ├── batch_service.py  # 批次服务
│   │   │   ├── import_service.py # 导入服务
│   │   │   ├── aggregation_service.py  # 聚合服务
│   │   │   └── validation_service.py  # 校验服务
│   │   │
│   │   ├── core/                  # 核心功能模块
│   │   │   ├── __init__.py
│   │   │   ├── parsing/           # 数据解析模块
│   │   │   │   ├── __init__.py
│   │   │   │   ├── file_reader.py      # 文件读取
│   │   │   │   ├── encoding_detector.py  # 编码检测
│   │   │   │   ├── delimiter_detector.py # 分隔符检测
│   │   │   │   └── title_row_handler.py  # 标题行处理
│   │   │   │
│   │   │   ├── cleaning/          # 数据清洗模块
│   │   │   │   ├── __init__.py
│   │   │   │   ├── field_mapper.py     # 字段映射
│   │   │   │   ├── type_converter.py   # 类型转换
│   │   │   │   ├── data_standardizer.py # 数据标准化
│   │   │   │   └── hash_generator.py   # 哈希生成
│   │   │   │
│   │   │   ├── validation/         # 数据校验模块
│   │   │   │   ├── __init__.py
│   │   │   │   ├── balance_validator.py    # 平衡校验
│   │   │   │   ├── anomaly_detector.py     # 异常检测
│   │   │   │   └── member_payment_check.py # 会员支付校验
│   │   │   │
│   │   │   ├── import/             # 数据入库模块
│   │   │   │   ├── __init__.py
│   │   │   │   ├── batch_manager.py    # 批次管理
│   │   │   │   ├── raw_importer.py     # 原始数据入库
│   │   │   │   ├── fact_importer.py     # 事实表入库
│   │   │   │   └── dimension_linker.py # 维度关联
│   │   │   │
│   │   │   ├── calculations/       # 口径计算模块
│   │   │   │   ├── __init__.py
│   │   │   │   ├── kpi_calculator.py    # KPI计算
│   │   │   │   └── payment_classifier.py # 支付方式分类
│   │   │   │
│   │   │   └── aggregations/      # 聚合计算模块
│   │   │       ├── __init__.py
│   │   │       ├── daily_aggregator.py  # 日级聚合
│   │   │       ├── weekly_aggregator.py # 周级聚合
│   │   │       ├── monthly_aggregator.py # 月级聚合
│   │   │       └── topn_query.py        # TopN查询
│   │   │
│   │   ├── utils/                  # 工具函数
│   │   │   ├── __init__.py
│   │   │   ├── auth.py            # 认证工具
│   │   │   ├── validators.py      # 验证工具
│   │   │   ├── logger.py           # 日志工具
│   │   │   └── exceptions.py      # 异常定义
│   │   │
│   │   └── middleware/             # 中间件
│   │       ├── __init__.py
│   │       ├── auth_middleware.py  # 认证中间件
│   │       └── audit_middleware.py # 审计中间件
│   │
│   ├── alembic/                   # 数据库迁移
│   │   ├── versions/              # 迁移脚本
│   │   ├── env.py
│   │   └── alembic.ini
│   │
│   ├── tests/                     # 测试文件
│   │   ├── unit/                  # 单元测试
│   │   │   ├── test_parsing.py
│   │   │   ├── test_cleaning.py
│   │   │   ├── test_validation.py
│   │   │   └── test_calculations.py
│   │   ├── integration/           # 集成测试
│   │   │   ├── test_import.py
│   │   │   └── test_aggregation.py
│   │   └── fixtures/              # 测试数据
│   │       └── sample_files/      # 样例文件
│   │
│   ├── scripts/                   # 脚本工具
│   │   ├── init_db.py             # 数据库初始化
│   │   ├── init_dimensions.py     # 维度数据初始化
│   │   ├── init_field_mapping.py  # 字段映射初始化
│   │   └── create_partitions.py  # 分区创建脚本
│   │
│   ├── requirements.txt           # Python依赖
│   ├── .env.example               # 环境变量示例
│   └── README.md                  # 后端README
│
├── frontend/                      # 前端应用
│   ├── src/
│   │   ├── components/           # 公共组件
│   │   │   ├── Layout/           # 布局组件
│   │   │   ├── Table/            # 表格组件
│   │   │   ├── Chart/            # 图表组件
│   │   │   ├── Filter/           # 筛选器组件
│   │   │   └── Upload/           # 上传组件
│   │   │
│   │   ├── pages/                # 页面组件
│   │   │   ├── Login/             # 登录页
│   │   │   ├── Dashboard/        # 指标看板
│   │   │   ├── BatchManagement/  # 批次管理
│   │   │   ├── DataQuery/        # 数据查询
│   │   │   └── ValidationReport/ # 校验报告
│   │   │
│   │   ├── services/             # API服务
│   │   │   ├── api.js            # API客户端
│   │   │   ├── auth.js            # 认证服务
│   │   │   ├── batch.js           # 批次服务
│   │   │   └── aggregation.js    # 聚合服务
│   │   │
│   │   ├── store/                # 状态管理
│   │   │   ├── auth.js           # 认证状态
│   │   │   └── app.js            # 应用状态
│   │   │
│   │   ├── utils/                # 工具函数
│   │   │   ├── request.js        # HTTP请求封装
│   │   │   └── format.js         # 格式化工具
│   │   │
│   │   ├── hooks/                # 自定义Hooks
│   │   │   └── useAuth.js        # 认证Hook
│   │   │
│   │   └── App.jsx               # 根组件
│   │
│   ├── public/                   # 静态资源
│   ├── package.json
│   └── README.md                # 前端README
│
├── data/                         # 数据目录
│   ├── raw/                      # 原始文件存储
│   │   └── {store_name}/         # 按门店组织
│   │       └── {table_type}/      # 按表类型组织
│   ├── output_csv/               # 导出CSV目录
│   └── sample_files/             # 样例文件
│
├── config/                       # 配置文件目录
│   ├── database.yaml             # 数据库配置
│   └── logging.yaml              # 日志配置
│
├── .gitignore
├── README.md                     # 项目README
└── requirements.txt              # 项目依赖（可选）
```

### 3.2 后端核心模块说明

#### 3.2.1 数据解析模块（parsing/）

**职责**：文件读取、编码检测、分隔符检测、标题行处理

**关键文件**：
- `file_reader.py`：统一文件读取接口，支持CSV/xls/xlsx
- `encoding_detector.py`：编码自动检测
- `delimiter_detector.py`：分隔符自动检测
- `title_row_handler.py`：标题行识别和删除

#### 3.2.2 数据清洗模块（cleaning/）

**职责**：字段映射、类型转换、数据标准化、哈希生成

**关键文件**：
- `field_mapper.py`：应用字段映射表，将原列名转换为业务字段名
- `type_converter.py`：数据类型转换（金额、时间、时长等）
- `data_standardizer.py`：数据标准化（文本清洗、分类字段统一）
- `hash_generator.py`：行哈希和文件校验和生成

#### 3.2.3 数据校验模块（validation/）

**职责**：平衡校验、异常检测、会员支付去重校验

**关键文件**：
- `balance_validator.py`：实收金额平衡校验
- `anomaly_detector.py`：异常检测（负值、时间交叉等）
- `member_payment_check.py`：会员支付去重校验

#### 3.2.4 数据入库模块（import/）

**职责**：批次管理、原始数据入库、事实表入库、维度关联

**关键文件**：
- `batch_manager.py`：文件批次创建和管理
- `raw_importer.py`：原始数据入库（raw_rows表）
- `fact_importer.py`：事实表入库（fact_*表）
- `dimension_linker.py`：维度关联（门店、员工、包厢、商品）

#### 3.2.5 口径计算模块（calculations/）

**职责**：实收金额计算、业绩计算、毛利计算

**关键文件**：
- `kpi_calculator.py`：核心指标计算函数
- `payment_classifier.py`：支付方式分类（收入类/成本权益类）

#### 3.2.6 聚合计算模块（aggregations/）

**职责**：日级/周级/月级聚合、TopN查询、宽表刷新

**关键文件**：
- `daily_aggregator.py`：日级聚合SQL和执行
- `weekly_aggregator.py`：周级聚合SQL和执行
- `monthly_aggregator.py`：月级聚合SQL和执行
- `topn_query.py`：TopN查询SQL和执行

### 3.3 前端模块说明

#### 3.3.1 页面组件（pages/）

- `Login/`：登录页面
- `Dashboard/`：指标看板页面
- `BatchManagement/`：批次管理页面（列表、详情）
- `DataQuery/`：数据查询页面（多维度筛选、表格、图表）
- `ValidationReport/`：校验报告页面

#### 3.3.2 公共组件（components/）

- `Layout/`：布局组件（Header、Sidebar、Footer）
- `Table/`：数据表格组件（支持排序、分页、筛选）
- `Chart/`：图表组件（基于ECharts封装）
- `Filter/`：筛选器组件（时间范围、门店、员工等）
- `Upload/`：文件上传组件（支持拖拽、进度显示）

---

## 四、技术栈选择

### 4.1 后端技术栈

| 技术 | 版本 | 用途 | 说明 |
|------|------|------|------|
| Python | 3.9+ | 开发语言 | 推荐3.9或3.10 |
| FastAPI | 0.100+ | Web框架 | 高性能、自动API文档 |
| SQLAlchemy | 2.0+ | ORM框架 | 数据库操作 |
| Alembic | 1.11+ | 数据库迁移 | 版本管理 |
| Pandas | 2.0+ | 数据处理 | 文件解析、数据清洗 |
| Pydantic | 2.0+ | 数据验证 | API请求/响应验证 |
| python-docx | 0.8+ | DOC/DOCX解析 | 文档解析（如需要） |
| chardet | 5.0+ | 编码检测 | 文件编码自动检测 |
| PyJWT | 2.8+ | JWT认证 | Token生成和验证 |
| python-multipart | 0.0+ | 文件上传 | FastAPI文件上传支持 |
| APScheduler | 3.10+ | 任务调度 | 定时任务（可选） |
| Celery | 5.3+ | 异步任务 | 后台任务处理（可选） |

### 4.2 前端技术栈

| 技术 | 版本 | 用途 | 说明 |
|------|------|------|------|
| React | 18.0+ | 前端框架 | 或Vue 3.0+ |
| TypeScript | 5.0+ | 类型系统 | 推荐使用（可选） |
| Ant Design | 5.0+ | UI组件库 | React版本，或Element UI（Vue） |
| ECharts | 5.4+ | 图表库 | 数据可视化 |
| Axios | 1.5+ | HTTP客户端 | API请求 |
| React Router | 6.0+ | 路由管理 | 或Vue Router |
| Redux | 8.0+ | 状态管理 | 或Vuex/Pinia（Vue） |
| Vite | 5.0+ | 构建工具 | 或Create React App |

### 4.3 数据库技术栈

| 技术 | 版本 | 用途 | 说明 |
|------|------|------|------|
| MySQL | 5.7+/8.0+ | 关系型数据库 | 推荐8.0+（支持窗口函数、物化视图） |
| Redis | 7.0+ | 缓存（可选） | 缓存热点查询结果 |

### 4.4 开发工具

| 工具 | 用途 | 说明 |
|------|------|------|
| Git | 版本控制 | 代码版本管理 |
| Docker | 容器化 | 开发环境统一（可选） |
| pytest | 测试框架 | Python单元测试和集成测试 |
| Black | 代码格式化 | Python代码格式化 |
| Flake8 | 代码检查 | Python代码规范检查 |
| ESLint | 代码检查 | JavaScript/TypeScript代码规范检查 |
| Prettier | 代码格式化 | JavaScript/TypeScript代码格式化 |

---

## 五、开发环境配置

### 5.1 Python环境配置

**推荐使用虚拟环境**：
```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境（Windows）
venv\Scripts\activate

# 激活虚拟环境（Linux/Mac）
source venv/bin/activate

# 安装依赖
pip install -r backend/requirements.txt
```

### 5.2 数据库配置

**MySQL安装和配置**：
```bash
# 创建数据库
CREATE DATABASE ktv_report CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建用户并授权
CREATE USER 'ktv_user'@'%' IDENTIFIED BY 'password';
GRANT ALL PRIVILEGES ON ktv_report.* TO 'ktv_user'@'%';
FLUSH PRIVILEGES;
```

**环境变量配置（.env）**：
```env
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=ktv_user
DB_PASSWORD=password
DB_NAME=ktv_report

# JWT配置
JWT_SECRET_KEY=your-secret-key
JWT_ALGORITHM=HS256
JWT_EXPIRATION_HOURS=24

# 文件存储配置
FILE_STORAGE_PATH=./data/raw
MAX_FILE_SIZE=104857600  # 100MB

# 日志配置
LOG_LEVEL=INFO
LOG_FILE=./logs/app.log
```

### 5.3 前端环境配置

**Node.js环境**：
```bash
# 安装Node.js（推荐18.0+）
# 使用nvm管理Node版本（推荐）

# 安装依赖
cd frontend
npm install

# 启动开发服务器
npm run dev
```

---

## 六、开发规范

### 6.1 代码规范

**Python代码规范**：
- 遵循PEP 8规范
- 使用Black进行代码格式化
- 使用Flake8进行代码检查
- 函数单一职责，避免使用`any`类型
- 函数和类必须有文档字符串

**JavaScript/TypeScript代码规范**：
- 使用ESLint和Prettier
- 遵循Airbnb或Standard规范
- 组件和函数必须有注释

### 6.2 命名规范

**Python命名规范**：
- 模块名：小写字母+下划线（snake_case）
- 类名：大驼峰（PascalCase）
- 函数名：小写字母+下划线（snake_case）
- 常量名：大写字母+下划线（UPPER_SNAKE_CASE）

**数据库命名规范**：
- 表名：小写字母+下划线（snake_case）
- 字段名：小写字母+下划线（snake_case）
- 索引名：`idx_{table}_{field}`

**API命名规范**：
- RESTful风格
- 资源使用名词，避免动词
- 版本号：`/api/v1/`

### 6.3 Git提交规范

**提交消息格式**：
```
<type>(<scope>): <subject>

<body>

<footer>
```

**类型（type）**：
- `feat`：新功能
- `fix`：修复bug
- `docs`：文档更新
- `style`：代码格式调整
- `refactor`：代码重构
- `test`：测试相关
- `chore`：构建/工具相关

**示例**：
```
feat(parsing): 实现文件编码自动检测功能

- 支持UTF-8、GBK、GB2312编码检测
- 使用chardet库进行编码检测
- 添加编码检测单元测试
```

---

## 七、测试策略

### 7.1 单元测试

**覆盖率目标**：核心模块（parsing、cleaning、validation、calculations）达到80%+

**测试文件组织**：
- `tests/unit/test_parsing.py`：解析模块测试
- `tests/unit/test_cleaning.py`：清洗模块测试
- `tests/unit/test_validation.py`：校验模块测试
- `tests/unit/test_calculations.py`：口径计算测试

### 7.2 集成测试

**测试场景**：
- 端到端文件导入流程
- 数据入库流程
- 聚合计算流程
- API接口测试

**测试文件组织**：
- `tests/integration/test_import.py`：导入流程测试
- `tests/integration/test_aggregation.py`：聚合流程测试
- `tests/integration/test_api.py`：API接口测试

### 7.3 测试数据

**样例文件**：
- `tests/fixtures/sample_files/`：存放三张表的样例文件
- 使用真实样例文件进行测试

---

## 八、部署方案

### 8.1 开发环境

**后端**：
```bash
cd backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**前端**：
```bash
cd frontend
npm run dev
```

### 8.2 生产环境

**推荐部署方案**：
- 后端：Docker容器 + Nginx反向代理
- 前端：Nginx静态文件服务
- 数据库：MySQL主从复制（可选）

**Docker Compose示例**：
```yaml
version: '3.8'
services:
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DB_HOST=mysql
      - DB_NAME=ktv_report
    depends_on:
      - mysql
  
  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend
  
  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=root_password
      - MYSQL_DATABASE=ktv_report
    volumes:
      - mysql_data:/var/lib/mysql
```

---

## 九、里程碑与交付物

### 9.1 第一阶段交付物（Week 2）

- [x] 需求文档
- [ ] 数据库设计文档
- [ ] Alembic迁移脚本
- [ ] 数据库初始化脚本

### 9.2 第二阶段交付物（Week 3）

- [ ] 字段映射配置数据
- [ ] 维度表初始化数据
- [ ] 字段映射查询服务

### 9.3 第三阶段交付物（Week 5）

- [ ] 数据解析模块
- [ ] 数据清洗模块
- [ ] 数据校验模块
- [ ] 单元测试用例

### 9.4 第四阶段交付物（Week 7）

- [ ] 数据入库模块
- [ ] 批次管理服务
- [ ] 集成测试用例

### 9.5 第五阶段交付物（Week 9）

- [ ] 聚合计算模块
- [ ] 口径计算模块
- [ ] 宽表刷新服务
- [ ] 性能测试报告

### 9.6 第六阶段交付物（Week 12）

- [ ] 后端API服务
- [ ] 前端Web应用
- [ ] API文档
- [ ] 用户手册

---

## 十、风险与应对

### 10.1 技术风险

**风险1**：文件格式不统一，解析失败率高
- **应对**：加强异常处理，支持多种格式，记录详细错误日志

**风险2**：数据量增长导致性能问题
- **应对**：使用分区表、索引优化、缓存策略、考虑分库分表

**风险3**：字段映射变更频繁
- **应对**：版本化管理字段映射，支持多版本共存

### 10.2 业务风险

**风险1**：实收口径不明确
- **应对**：与业务方确认口径，配置化支付方式分类，支持灵活调整

**风险2**：数据质量差，校验失败率高
- **应对**：加强数据清洗，记录详细告警，支持人工审核

### 10.3 项目风险

**风险1**：开发周期延长
- **应对**：分阶段交付，优先核心功能，后续迭代优化

**风险2**：人员变动
- **应对**：完善文档，代码注释，知识分享

---

## 十一、后续优化方向

### 11.1 功能扩展

- [ ] 支持更多表类型
- [ ] 支持更多导出格式（Excel、PDF）
- [ ] 支持自定义报表
- [ ] 支持数据对比分析
- [ ] 支持移动端访问

### 11.2 性能优化

- [ ] 查询结果缓存（Redis）
- [ ] 异步任务处理（Celery）
- [ ] 数据库读写分离
- [ ] CDN加速（前端静态资源）

### 11.3 监控与运维

- [ ] 日志聚合和分析（ELK）
- [ ] 性能监控（Prometheus + Grafana）
- [ ] 错误监控（Sentry）
- [ ] 自动化测试（CI/CD）

---

## 十二、参考文档

- 《具体需求.md》：业务需求说明
- 《字段映射.md》：字段映射规范
- 《解析与清洗.md》：数据解析与清洗规范
- 《入库模型.md》：数据库入库模型设计
- 《聚合.md》：聚合与口径计算设计
- 《web界面.md》：Web界面与接口设计

---

## 十三、版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2025-12-03 | 初始版本，完成开发框架指南 |

---

**文档结束**

