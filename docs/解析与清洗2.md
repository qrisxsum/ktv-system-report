# 解析与清洗流水线实施文档

## 文档说明

本文档基于《具体需求.md》《字段映射.md》和《详细业务分析实现.md》，详细描述KTV多门店报表自动化系统中数据解析与清洗流水线的实施步骤、技术方案和操作规范。

**版本号**: v1.0  
**生成日期**: 2025-12-03  
**目标**: 稳定读取CSV/xls文件，删除首行标题，应用字段映射，生成校验结果与行哈希，确保数据质量和幂等性

---

## 一、总体目标与架构

### 1.1 核心目标

1. **稳定读取**：支持CSV优先，兼容xls/xlsx格式，自动处理编码和分隔符问题
2. **标题处理**：自动识别并删除首行整表标题行
3. **字段映射**：应用字段映射表，将原始列名转换为业务字段名
4. **数据标准化**：统一数据类型、格式和精度
5. **质量校验**：执行关键业务规则校验，生成告警
6. **幂等保障**：生成行哈希和文件校验和，支持重复导入去重

### 1.2 处理流程概览

```
文件输入 → 编码/分隔符探测 → 读取原始数据 → 删除标题行 → 保留原列信息 
→ 应用字段映射 → 类型转换 → 数据标准化 → 生成行哈希 → 关键校验 
→ 输出清洗后数据 + 告警列表 + 元数据
```

### 1.3 输入输出规范

**输入**：
- 文件路径（CSV/xls/xlsx）
- 表类型（预订汇总/酒水销售分析/包厢开台分析）
- 字段映射表（版本化）
- 门店信息（从文件名解析或映射表）

**输出**：
- 清洗后的DataFrame（业务字段名）
- 原始列信息（元数据）
- 行哈希列（用于幂等）
- 文件校验和（MD5/SHA256）
- 告警列表（JSON格式）
- 解析状态报告

---

## 二、详细实施步骤

### 步骤1：编码与分隔符探测

#### 2.1.1 目标
自动识别文件编码和分隔符，确保正确读取数据，避免乱码和列错位。

#### 2.1.2 技术方案

**编码探测**：
- 使用 `chardet` 库自动检测文件编码
- 优先级：UTF-8 > GBK > GB2312 > 其他
- 如果检测置信度低于阈值（建议0.7），尝试常见编码列表
- 异常情况：记录告警，使用UTF-8并尝试 `errors='ignore'` 或 `errors='replace'`

**分隔符探测**：
- 使用 `csv.Sniffer` 自动检测分隔符
- 优先级：逗号（`,`）> 制表符（`\t`）> 分号（`;`）
- 读取前N行（建议10-20行）进行探测
- 异常情况：如果探测失败或置信度低，回退到制表符（`\t`）

#### 2.1.3 实施细节

1. **文件读取策略**：
   - 先以二进制模式读取文件前1KB用于编码检测
   - 编码检测成功后，以文本模式读取完整文件
   - 对于大文件（>100MB），考虑分块读取

2. **编码检测流程**：
   ```
   读取文件前1KB → chardet.detect() → 检查置信度
   → 如果置信度 >= 0.7，使用检测结果
   → 否则，按优先级尝试：UTF-8 → GBK → GB2312
   → 记录最终使用的编码和检测置信度
   ```

3. **分隔符检测流程**：
   ```
   读取前20行文本 → csv.Sniffer().sniff() → 检测分隔符
   → 验证分隔符有效性（列数一致性）
   → 如果检测失败，回退到制表符
   → 记录最终使用的分隔符
   ```

4. **异常处理**：
   - 编码检测失败：记录告警，尝试UTF-8，如果仍有错误则尝试GBK
   - 分隔符检测失败：记录告警，使用制表符作为默认值
   - 文件无法读取：抛出异常，记录到批次状态

#### 2.1.4 输出
- 检测到的编码（字符串）
- 检测到的分隔符（字符串）
- 检测置信度（浮点数，0-1）
- 告警信息（如有）

---

### 步骤2：读取与标题行处理

#### 2.2.1 目标
读取文件数据，识别并删除首行整表标题行，保留原始列名和顺序信息。

#### 2.2.2 标题行识别规则

根据《具体需求.md》和《字段映射.md》：

**预订汇总表**：
- 首行第一列通常包含整表标题文本（如"预订汇总"）
- 第二行开始为列名（多级表头可能被拍平）
- 第三行开始为数据行

**酒水销售分析表**：
- 首行可能包含整表标题或类别信息
- 第二行开始为列名（多级表头被拍平）
- 第三行开始为数据行

**包厢开台分析表**：
- 首行第一列通常包含整表标题或包厢号（实际为标题行）
- 第二行开始为列名
- 第三行开始为数据行

#### 2.2.2 技术方案

1. **读取策略**：
   - 使用pandas读取，`header=None`先读取所有行
   - 根据表类型和首行特征判断是否为标题行
   - 删除标题行后，重新设置列名

2. **标题行识别逻辑**：
   ```
   读取前3行 → 分析第一行特征
   → 如果第一行第一列包含"汇总"、"分析"、"报表"等关键词 → 判定为标题行
   → 如果第一行所有列的非空值 < 3 → 判定为标题行
   → 如果第一行与第二行结构差异大（列数不一致） → 判定为标题行
   → 否则，第一行视为列名
   ```

3. **列名处理**：
   - 保留原始列名（包括"列X"格式）
   - 记录列的顺序（位置索引）
   - 对于多级表头被拍平的情况，保留拍平后的列名
   - 将原始列名信息写入元数据表

#### 2.2.3 实施细节

1. **pandas读取参数**：
   - `header=None`：先不自动识别列名
   - `skip_blank_lines=False`：保留空行用于判断
   - `keep_default_na=False`：不自动转换NA值，后续统一处理

2. **标题行删除**：
   - 识别标题行后，使用 `df.drop(index=0)` 删除
   - 重置索引：`df.reset_index(drop=True)`
   - 记录删除的行号和内容（用于审计）

3. **列名设置**：
   - 标题行删除后，第一行作为列名
   - 如果列名为空或重复，生成占位名（如"列0"、"列1"）
   - 保存原始列名到元数据字典

#### 2.2.4 输出
- DataFrame（已删除标题行）
- 原始列名列表（按顺序）
- 标题行内容（用于审计）
- 告警信息（如果标题行识别异常）

---

### 步骤3：字段映射应用

#### 2.3.1 目标
根据字段映射表，将原始列名转换为业务字段名，支持版本化映射。

#### 2.3.2 映射表结构

根据《字段映射.md》，映射表包含以下字段：
- `table_type`：表类型（booking_summary/beverage_sales/room_analysis）
- `original_column_name`：原始列名
- `business_field_name`：业务字段名
- `data_type`：数据类型
- `is_required`：是否必填
- `version`：映射版本号
- `description`：口径说明
- `remarks`：备注

#### 2.3.3 映射应用流程

1. **加载映射表**：
   - 从数据库或配置文件加载字段映射表
   - 按表类型和版本号筛选
   - 构建原始列名 → 业务字段名的字典

2. **列名匹配**：
   - 精确匹配：原始列名完全一致
   - 模糊匹配：处理列名中的空格、特殊字符差异
   - 未匹配列：保留原始列名，标记为"待映射"

3. **重命名操作**：
   - 使用 `df.rename(columns=mapping_dict)` 重命名
   - 记录映射结果（成功/失败/待确认）
   - 对于"列X"格式的列，如果映射表中无对应项，保留原名并生成待办

4. **列顺序调整**：
   - 根据映射表的建议顺序调整列顺序（可选）
   - 保留原始列顺序信息

#### 2.3.4 实施细节

1. **映射优先级**：
   - 优先使用最新版本的映射
   - 如果同一列有多个版本映射，选择版本号最高的
   - 如果映射表中无对应项，保留原始列名

2. **未映射列处理**：
   - 记录未映射的列名和位置
   - 生成"字段映射待办"记录
   - 在告警中标记，但不阻断处理流程

3. **映射验证**：
   - 检查必填字段是否都已映射
   - 检查数据类型是否合理
   - 生成映射报告

#### 2.3.5 输出
- DataFrame（列名已转换为业务字段名）
- 映射结果报告（成功/失败/待确认）
- 未映射列列表
- 字段映射待办记录

---

### 步骤4：类型转换与数据标准化

#### 2.4.1 目标
统一数据类型、格式和精度，确保数据质量。

#### 2.4.2 转换规则

根据《字段映射.md》和《具体需求.md》：

**金额字段**：
- 数据类型：`DECIMAL(12,2)`，Python中对应 `float64`
- 精度：保留2位小数
- 缺失值：填充为 `0.0`
- 负值检查：除调整金额外，其他金额不应为负（需校验）

**时间字段**：
- 数据类型：`TIMESTAMP` 或 `DATE`
- 格式：统一为ISO8601格式（`YYYY-MM-DD HH:MM:SS`）
- 时区：统一为门店时区或UTC
- 缺失值：对于必填时间字段，缺失时记录告警；对于可选字段，保留为NULL

**时长字段**：
- 数据类型：`INTEGER`（分钟）
- 转换：如果原始数据为小时，转换为分钟
- 缺失值：填充为 `0`

**计数字段**：
- 数据类型：`INTEGER`
- 缺失值：填充为 `0`
- 负值检查：不应为负（需校验）

**文本字段**：
- 数据类型：`VARCHAR`
- 清洗：去除前后空格，统一大小写（可选）
- 缺失值：对于必填字段，缺失时记录告警；对于可选字段，保留为空字符串或NULL

**分类字段**：
- 统一格式：去除空格、统一大小写、处理全角半角
- 建立映射表：门店名、员工名、包厢名等需要标准化映射

#### 2.4.3 实施细节

1. **金额字段处理**：
   ```python
   # 伪代码示例
   for col in amount_columns:
       df[col] = pd.to_numeric(df[col], errors='coerce')
       df[col] = df[col].fillna(0.0)
       df[col] = df[col].round(2)
   ```

2. **时间字段处理**：
   ```python
   # 伪代码示例
   for col in time_columns:
       df[col] = pd.to_datetime(df[col], errors='coerce', format='%Y-%m-%d %H:%M:%S')
       # 时区转换（如需要）
       # 缺失值处理
   ```

3. **文本字段清洗**：
   ```python
   # 伪代码示例
   for col in text_columns:
       df[col] = df[col].astype(str).str.strip()
       # 统一大小写（如需要）
       # 处理全角半角（如需要）
   ```

4. **分类字段标准化**：
   - 建立维度映射表（门店、员工、包厢等）
   - 使用映射表进行标准化
   - 未匹配的值记录告警

#### 2.4.4 输出
- DataFrame（数据类型已转换，格式已标准化）
- 转换报告（成功/失败统计）
- 告警信息（缺失值、格式错误等）

---

### 步骤5：行哈希与文件校验和生成

#### 2.5.1 目标
生成行级哈希和文件级校验和，用于幂等性控制和去重。

#### 2.5.2 行哈希生成规则

**哈希内容**：
- 文件路径（绝对路径）
- 行号（原始文件中的行号，考虑标题行）
- 原始行数据（JSON格式，包含所有原始列）

**哈希算法**：
- 使用SHA256算法
- 将文件路径、行号、原始行JSON拼接后计算哈希
- 生成固定长度的哈希字符串（64字符）

**实施细节**：
1. 在删除标题行之前，保存原始行的JSON表示
2. 对每一行，构建哈希输入字符串：
   ```
   hash_input = f"{file_path}|{row_number}|{row_json}"
   ```
3. 计算SHA256哈希值
4. 将哈希值作为新列添加到DataFrame

#### 2.5.3 文件校验和生成

**校验和内容**：
- 文件完整内容（二进制）

**校验和算法**：
- 使用MD5或SHA256
- 推荐使用SHA256（更安全）

**实施细节**：
1. 读取文件的二进制内容
2. 计算SHA256哈希值
3. 保存到文件批次表的`file_checksum`字段

#### 2.5.4 幂等性控制

**去重策略**：
- 在入库前，检查行哈希是否已存在
- 如果存在，根据策略决定：跳过（幂等）或覆盖（更新）
- 记录去重统计（跳过行数、覆盖行数）

**批次管理**：
- 每个文件导入创建一个批次记录
- 批次包含：文件路径、校验和、时间范围、门店、解析状态
- 支持按批次重跑和回滚

#### 2.5.5 输出
- DataFrame（包含`row_hash`列）
- 文件校验和（字符串）
- 去重统计（如有）

---

### 步骤6：关键业务规则校验

#### 2.6.1 目标
执行关键业务规则校验，确保数据质量和业务逻辑正确性。

#### 2.6.2 校验规则清单

根据《字段映射.md》和《具体需求.md》：

**1. 预订汇总表校验**

**实收金额平衡校验**：
```
实收金额 ≈ 销售金额 - 免单金额 - 挂账金额 - 折扣金额 - 抹零金额 - 调整金额
```
- 注意：赠送金额不参与实收计算
- 允许误差：建议1元以内
- 不平衡时生成告警

**支付方式合计校验**：
```
实收金额 ≈ 收入类支付方式合计
收入类支付方式 = 微信支付 + 支付宝 + 现金 + pos银行卡 + 服务员收款 + 付呗 + 团购 + 抖音 + POS机 + 高德
```
- 注意：会员本金不计入收入类支付方式
- 允许误差：建议1元以内

**会员支付去重校验**：
```
会员支付 ≈ 会员本金 + 会员赠送
```
- 如果不一致，记录告警（用于会员权益分析）

**负值检查**：
- 销售金额、实收金额、基本业绩不应为负
- 调整金额可以为负（正负均可）
- 其他金额字段不应为负

**2. 酒水销售分析表校验**

**成本平衡校验**：
```
成本_小计 = 成本_销售 + 成本_赠送
```

**利润计算校验**：
```
利润 = 销售金额_小计 - 成本_小计
```

**数量金额平衡校验**：
```
合计_数量 = 销售数量_小计 + 赠送数量_小计
合计_金额 = 销售金额_小计 + 赠送金额_小计
```

**负值检查**：
- 成本、利润不应为负（需关注负利润）
- 数量不应为负

**3. 包厢开台分析表校验**

**实收金额平衡校验**：
```
实收金额 ≈ 账单合计 - 抹零金额 - 调整金额 - 挂账金额 - 免单金额 - 房费折扣金额 - 酒水折扣金额 - 权益类支付方式合计
```

**支付方式合计校验**：
```
实收金额 ≈ 收入类支付方式合计
收入类支付方式 = 微信支付 + 支付宝 + 现金 + 银行卡 + 服务员收款 + 付呗 + 美团 + 抖音 + 扫码 + 高德
```

**会员支付去重校验**：
```
会员支付 ≈ 会员本金 + 会员赠送
```

**时间逻辑校验**：
- 开房时间不应晚于关房时间
- 关房时间不应晚于清洁时间
- 消费时长应等于关房时间 - 开房时间（允许误差5分钟）

**负值检查**：
- 账单合计、实收金额、基本业绩不应为负
- 调整金额可以为负

**4. 通用校验**

**列缺失/新增检查**：
- 对比当前文件的列与映射表中的预期列
- 记录缺失的列（必填列缺失时告警）
- 记录新增的列（生成字段映射待办）

**数据类型检查**：
- 验证转换后的数据类型是否符合预期
- 记录类型转换失败的字段

**缺失值检查**：
- 检查必填字段的缺失情况
- 记录缺失率统计

#### 2.6.3 校验实施流程

1. **校验函数设计**：
   - 每个校验规则实现为独立函数
   - 函数输入：DataFrame、表类型、配置参数
   - 函数输出：告警列表（JSON格式）

2. **告警格式**：
   ```json
   {
     "alert_type": "balance_check",
     "table_type": "booking_summary",
     "rule_name": "实收金额平衡校验",
     "severity": "error",
     "message": "实收金额与计算值不一致",
     "details": {
       "row_index": 5,
       "expected": 1000.00,
       "actual": 999.50,
       "difference": 0.50
     },
     "timestamp": "2025-12-03T10:00:00Z"
   }
   ```

3. **校验执行顺序**：
   - 先执行基础校验（数据类型、缺失值）
   - 再执行业务规则校验（平衡、逻辑）
   - 最后执行异常检测（负值、时间交叉）

4. **告警分级**：
   - `error`：严重错误，影响数据质量（如平衡不平、必填字段缺失）
   - `warning`：警告，需要关注（如负利润、时间逻辑异常）
   - `info`：信息，记录但不影响处理（如新增列、可选字段缺失）

#### 2.6.4 输出
- 告警列表（JSON数组）
- 校验报告（统计信息）
- 异常数据明细（可选）

---

## 三、异常处理与容错机制

### 3.1 文件读取异常

**场景**：
- 文件不存在
- 文件损坏
- 权限不足

**处理**：
- 记录错误到批次状态
- 生成告警
- 跳过该文件，继续处理其他文件

### 3.2 编码/分隔符检测异常

**场景**：
- 编码检测失败
- 分隔符检测失败
- 检测结果置信度低

**处理**：
- 使用默认值（UTF-8、制表符）
- 记录告警
- 尝试读取，如果失败则标记为错误

### 3.3 标题行识别异常

**场景**：
- 无法识别标题行
- 标题行格式异常

**处理**：
- 记录告警
- 尝试多种识别策略
- 如果仍失败，保留第一行作为数据（可能影响后续处理）

### 3.4 字段映射异常

**场景**：
- 映射表中无对应列
- 必填字段未映射
- 映射版本不匹配

**处理**：
- 未映射列保留原始列名
- 生成字段映射待办
- 必填字段缺失时生成错误告警

### 3.5 类型转换异常

**场景**：
- 金额字段包含非数字字符
- 时间字段格式不正确
- 数据类型转换失败

**处理**：
- 使用 `errors='coerce'` 将无效值转换为NaN
- 缺失值填充默认值（金额填0，时间填NULL）
- 记录转换失败的字段和行号

### 3.6 校验异常

**场景**：
- 平衡校验不平
- 时间逻辑错误
- 负值异常

**处理**：
- 生成相应级别的告警
- 记录异常明细
- 不影响数据入库（仅告警），但可在配置中设置严格模式（校验失败时阻止入库）

---

## 四、性能优化建议

### 4.1 大文件处理

- 使用 `chunksize` 参数分块读取大文件
- 对于超大文件（>1GB），考虑流式处理
- 使用 `dtype` 参数显式声明数据类型，减少内存占用

### 4.2 并行处理

- 支持按文件并行处理（多进程）
- 支持按门店并行处理
- 注意线程安全（数据库连接池）

### 4.3 内存优化

- 及时释放不需要的DataFrame
- 使用 `category` 类型存储分类字段
- 避免不必要的副本操作

---

## 五、日志与监控

### 5.1 日志记录

**日志内容**：
- 文件读取开始/结束时间
- 编码/分隔符检测结果
- 标题行处理结果
- 字段映射统计
- 类型转换统计
- 校验结果统计
- 异常和告警

**日志格式**：
- 结构化日志（JSON格式）
- 包含批次号、文件名、表类型等上下文信息

### 5.2 监控指标

- 文件处理耗时
- 数据行数统计
- 告警数量统计
- 校验通过率
- 异常文件数量

---

## 六、测试建议

### 6.1 单元测试

- 编码/分隔符检测函数
- 标题行识别函数
- 字段映射函数
- 类型转换函数
- 行哈希生成函数
- 各校验规则函数

### 6.2 集成测试

- 端到端处理流程测试
- 使用真实样例文件测试
- 异常场景测试（文件损坏、编码错误等）

### 6.3 回归测试

- 字段映射变更后的回归测试
- 校验规则变更后的回归测试
- 确保历史文件仍能正确处理

---

## 七、实施检查清单

### 7.1 开发前准备

- [ ] 确认字段映射表已建立并版本化
- [ ] 确认三张表的样例文件已收集
- [ ] 确认编码/分隔符探测库已安装（chardet、csv）
- [ ] 确认pandas版本兼容性

### 7.2 开发实施

- [ ] 实现编码/分隔符探测功能
- [ ] 实现文件读取和标题行删除功能
- [ ] 实现字段映射应用功能
- [ ] 实现类型转换和数据标准化功能
- [ ] 实现行哈希和文件校验和生成功能
- [ ] 实现关键业务规则校验功能
- [ ] 实现异常处理和容错机制
- [ ] 实现日志记录功能

### 7.3 测试验证

- [ ] 单元测试覆盖所有核心函数
- [ ] 使用三张表的样例文件进行集成测试
- [ ] 验证告警生成正确性
- [ ] 验证行哈希唯一性
- [ ] 验证幂等性（重复导入去重）

### 7.4 文档与交付

- [ ] 代码注释完整
- [ ] 函数文档字符串完整
- [ ] 使用示例文档
- [ ] 异常处理说明文档

---

## 八、参考文档

- 《具体需求.md》：业务需求说明
- 《字段映射.md》：字段映射规范和校验规则
- 《详细业务分析实现.md》：整体技术方案

---

## 九、版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2025-12-03 | 初始版本，基于需求文档和字段映射文档生成 |

