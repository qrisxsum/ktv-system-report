# 入库模型设计文档 (Lite版)

## 文档说明

本文档基于《具体需求.md》《字段映射.md》和《简化.md》的要求，制定 KTV 报表系统的**简化版**数据库模型。

**核心理念**：保留核心事实表和维度表，**移除中间层（raw_rows）和复杂分区**，但**必须保留完整的业务指标字段**以满足报表需求。

**版本号**: v2.3 (Lite - Final Revised)  
**生成日期**: 2025-12-09  
**数据库选型**: MySQL 5.7/8.0 (推荐 8.0)

---

## 一、数据库选型与设计原则

### 1.1 选型说明
- **数据库**: MySQL 5.7+ 或 8.0+。
- **字符集**: `utf8mb4` / `utf8mb4_unicode_ci` (支持 Emoji)。
- **存储引擎**: InnoDB (事务支持)。

### 1.2 简化策略
1.  **移除 `raw_rows` 表**：原始数据直接解析入库，不再存储 JSON 格式的原始行。原始文件保留在磁盘作为备份。
2.  **移除表分区**：数据量级在百万级以内，普通索引足够应对，不再使用复杂的 RANGE 分区，降低维护成本。
3.  **核心+扩展模式**：
    -   **稳定字段独立建列**：核心金额（销售、实收）、关键扣减（折扣、挂账、抹零）、主流支付（微信、支付宝）。
    -   **动态字段 JSON 存储**：长尾支付方式（如数字人民币、消费券）存入 JSON，避免频繁 DDL。

---

## 二、Schema 概览

### 2.1 表分类 (共 9 张表)

1.  **核心元数据表** (1张):
    -   `meta_file_batch`: 文件导入批次管理。
2.  **维度表** (5张):
    -   `dim_store`: 门店。
    -   `dim_employee`: 员工/订房人。
    -   `dim_room`: 包厢。
    -   `dim_product`: 商品。
    -   `dim_payment_method`: 支付方式 (用于动态归类)。
3.  **事实表** (3张):
    -   `fact_booking`: 预订汇总。
    -   `fact_room`: 包厢开台。
    -   `fact_sales`: 酒水销售。

---

## 三、元数据表设计

### 3.1 文件批次表 (meta_file_batch)

**用途**：记录文件导入状态，支持幂等性和回滚。

| 字段名 | 类型 | 说明 |
|---|---|---|
| `id` | BIGINT PK | 自增主键 |
| `batch_no` | VARCHAR(50) | 唯一批次号 (YYYYMMDD_Store_Type) |
| `file_name` | VARCHAR(255) | 原始文件名 |
| `store_id` | INT | 关联门店 |
| `table_type` | VARCHAR(50) | 表类型 (booking/room/sales) |
| `status` | VARCHAR(20) | pending / success / failed |
| `row_count` | INT | 导入行数 |
| `error_log` | TEXT | 错误日志 (JSON格式) |
| `created_at` | DATETIME | 创建时间 |

**索引**:
- UNIQUE `idx_batch_no` (`batch_no`)
- INDEX `idx_store_date` (`store_id`, `created_at`)

---

## 四、维度表设计

### 4.1 门店维度表 (dim_store)

| 字段名 | 类型 | 说明 |
|---|---|---|
| `id` | INT PK | 代理键 |
| `store_name` | VARCHAR(100) | 门店名 (标准化) |
| `original_name` | VARCHAR(100) | 原始门店名 (用于匹配) |
| `is_active` | BOOLEAN | 是否启用 |

**索引**: UNIQUE `idx_store_name` (`store_name`)

### 4.2 员工维度表 (dim_employee)

| 字段名 | 类型 | 说明 |
|---|---|---|
| `id` | INT PK | 代理键 |
| `store_id` | INT | 关联门店 |
| `name` | VARCHAR(50) | 员工姓名 |
| `department` | VARCHAR(50) | 部门 (冗余便于查询) |

**索引**: INDEX `idx_store_name` (`store_id`, `name`)

### 4.3 包厢维度表 (dim_room)

| 字段名 | 类型 | 说明 |
|---|---|---|
| `id` | INT PK | 代理键 |
| `store_id` | INT | 关联门店 |
| `room_no` | VARCHAR(50) | 包厢号 |
| `room_type` | VARCHAR(50) | 包厢类型 |

**索引**: UNIQUE `idx_store_room` (`store_id`, `room_no`)

### 4.4 商品维度表 (dim_product)

| 字段名 | 类型 | 说明 |
|---|---|---|
| `id` | INT PK | 代理键 |
| `store_id` | INT | 关联门店 |
| `name` | VARCHAR(100) | 商品名称 |
| `category` | VARCHAR(50) | 商品分类 |

**索引**: INDEX `idx_store_product` (`store_id`, `name`)

---

## 五、事实表设计 (核心)

### 5.1 预订汇总事实表 (fact_booking)

| 字段名 | 类型 | 说明 |
|---|---|---|
| `id` | BIGINT PK | 自增主键 |
| `batch_id` | BIGINT | 关联批次 |
| `biz_date` | DATE | **营业日期** (核心查询维度) |
| `store_id` | INT | 关联门店 |
| `employee_id` | INT | 关联员工 (订位人) |
| `department` | VARCHAR(50)| 部门 (冗余) |
| `customer_name` | VARCHAR(50) | 订位人/客户名 |
| `booking_qty` | INT | 订台数 |
| `sales_amount` | DECIMAL(12,2)| 销售金额 (应收) |
| `actual_amount` | DECIMAL(12,2)| **实收金额** (计算字段) |
| `base_performance` | DECIMAL(12,2)| 基本业绩 |
| **扣减项** | | |
| `gift_amount` | DECIMAL(12,2)| 赠送金额 |
| `discount_amount` | DECIMAL(12,2)| 折扣金额 |
| `free_amount` | DECIMAL(12,2)| 免单金额 |
| `credit_amount` | DECIMAL(12,2)| **挂账金额** |
| `round_off_amount`| DECIMAL(12,2)| **抹零金额** |
| `adjustment_amount`| DECIMAL(12,2)| **调整金额** |
| **支付方式** | | |
| `pay_wechat` | DECIMAL(12,2)| 微信支付 |
| `pay_alipay` | DECIMAL(12,2)| 支付宝 |
| `pay_cash` | DECIMAL(12,2)| 现金 |
| `pay_pos` | DECIMAL(12,2)| POS/银行卡 |
| `pay_member` | DECIMAL(12,2)| 会员支付 (权益类) |
| `pay_douyin` | DECIMAL(12,2)| 抖音 (团购类) |
| `pay_meituan` | DECIMAL(12,2)| 美团/团购 |
| `extra_payments` | JSON | 其他支付方式 (JSON) |
| `created_at` | DATETIME | 入库时间 |

**索引**:
- INDEX `idx_date_store` (`biz_date`, `store_id`)
- INDEX `idx_batch` (`batch_id`)

### 5.2 包厢开台事实表 (fact_room)

| 字段名 | 类型 | 说明 |
|---|---|---|
| `id` | BIGINT PK | 自增主键 |
| `batch_id` | BIGINT | 关联批次 |
| `biz_date` | DATE | 营业日期 |
| `store_id` | INT | 关联门店 |
| `room_id` | INT | 关联包厢 |
| `order_no` | VARCHAR(50) | **开台单号** (业务主键) |
| `open_time` | DATETIME | 开房时间 |
| `close_time` | DATETIME | 关房时间 |
| `duration_min` | INT | 时长(分) |
| `bill_total` | DECIMAL(12,2)| 账单合计 |
| `actual_amount` | DECIMAL(12,2)| 实收金额 |
| `base_performance` | DECIMAL(12,2)| 基本业绩 |
| **扣减项** | | |
| `gift_amount` | DECIMAL(12,2)| 赠送金额 |
| `room_discount` | DECIMAL(12,2)| 房费折扣 |
| `beverage_discount`| DECIMAL(12,2)| 酒水折扣 |
| `free_amount` | DECIMAL(12,2)| 免单金额 |
| `credit_amount` | DECIMAL(12,2)| 挂账金额 |
| `round_off_amount`| DECIMAL(12,2)| 抹零金额 |
| `adjustment_amount`| DECIMAL(12,2)| 调整金额 |
| **支付方式** | | |
| `pay_wechat` | DECIMAL(12,2)| 微信支付 |
| `pay_alipay` | DECIMAL(12,2)| 支付宝 |
| `pay_cash` | DECIMAL(12,2)| 现金 |
| `pay_member` | DECIMAL(12,2)| 会员支付 |
| `pay_douyin` | DECIMAL(12,2)| 抖音 |
| `pay_meituan` | DECIMAL(12,2)| 美团/团购 |
| `extra_payments` | JSON | 其他支付方式 (JSON) |
| `created_at` | DATETIME | 入库时间 |

**索引**:
- INDEX `idx_date_store` (`biz_date`, `store_id`)
- UNIQUE `idx_order_no` (`order_no`)

### 5.3 酒水销售事实表 (fact_sales)

| 字段名 | 类型 | 说明 |
|---|---|---|
| `id` | BIGINT PK | 自增主键 |
| `batch_id` | BIGINT | 关联批次 |
| `biz_date` | DATE | 营业日期 |
| `store_id` | INT | 关联门店 |
| `product_id` | INT | 关联商品 |
| `sales_qty` | INT | 销售数量 |
| `sales_amount` | DECIMAL(12,2)| 销售金额 |
| `gift_qty` | INT | **赠送数量** (新增) |
| `gift_amount` | DECIMAL(12,2)| **赠送金额** (新增) |
| `cost_total` | DECIMAL(12,2)| 成本小计 |
| `profit` | DECIMAL(12,2)| 毛利 |
| `created_at` | DATETIME | 入库时间 |

**索引**:
- INDEX `idx_date_store` (`biz_date`, `store_id`)
- INDEX `idx_product` (`product_id`)

---

## 六、数据逻辑说明

1.  **JSON 字段处理**:
    -   在字段映射阶段，将所有未明确映射到独立列的 `pay_xxx` 字段，聚合到一个 Dictionary 中。
    -   入库时，将该 Dictionary 序列化为 JSON 存入 `extra_payments`。
2.  **平衡校验公式**:
    -   `FactBooking`: `actual_amount ≈ sales_amount - (gift + discount + free + credit + round_off + adjustment)`
    -   `FactRoom`: `actual_amount ≈ bill_total - (gift + room_discount + bev_discount + free + credit + round_off + adjustment)`
    -   *注：具体加减符号视数据正负而定，通常扣减项为正值时做减法。*

---

## 七、总结

v2.3 版本模型完整覆盖了《字段映射.md》中的核心财务字段，特别是补全了酒水销售表中的**赠送相关字段** (`gift_qty`, `gift_amount`)，确保了库存和营销分析的准确性。
