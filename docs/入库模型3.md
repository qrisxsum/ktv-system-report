# 入库模型设计文档

## 文档说明

本文档基于《具体需求.md》《字段映射.md》和《详细业务分析实现.md》的要求，详细设计 KTV 多门店报表自动化系统的数据库入库模型，包括表结构设计、主键策略、分区方案、索引设计、幂等性保障等核心内容。

**版本号**: v1.0  
**生成日期**: 2025-12-03  
**数据库选型**: MySQL 5.7+（推荐 MySQL 8.0+）

---

## 一、数据库选型与版本要求

### 1.1 选型说明

**选择 MySQL 的原因**：
- **JSON 类型支持**：MySQL 5.7+ 支持原生 JSON 类型，便于存储原始行的完整数据，支持灵活查询和审计
- **分区功能**：MySQL 5.7+ 支持 RANGE、LIST、HASH 分区，适合按时间分区的大表
- **窗口函数**：MySQL 8.0+ 支持窗口函数，便于复杂聚合查询
- **物化视图**：MySQL 8.0+ 支持物化视图，提升查询性能
- **生态成熟**：SQLAlchemy、Alembic 等 Python 工具链完善
- **运维友好**：备份、监控、性能调优工具成熟

**最低版本要求**：
- **MySQL 5.7.8+**：支持 JSON 类型、分区功能
- **推荐 MySQL 8.0+**：支持窗口函数、物化视图、更好的 JSON 性能

### 1.2 字符集与排序规则

- **数据库字符集**：`utf8mb4`
- **排序规则**：`utf8mb4_unicode_ci`
- **原因**：支持完整的 UTF-8 字符集（包括 emoji），避免中文乱码问题

---

## 二、Schema 设计概览

### 2.1 Schema 命名

建议创建独立的 schema（数据库）用于本项目：
- **Schema 名称**：`ktv_report` 或 `ktv_analytics`
- **用途**：隔离业务数据，便于备份和迁移

### 2.2 表分类

系统包含以下五类表：

1. **元数据表**：文件批次表、字段映射表、导入日志表
2. **原始数据表**：原始行表（存储清洗前的完整数据）
3. **维度表**：门店维、时间维、员工维、包厢维、商品维、支付方式维
4. **事实表**：预订汇总事实、包厢开台事实、酒水销售事实
5. **聚合表/视图**：日级/周级/月级聚合表、物化视图

### 2.3 表命名规范

- **命名风格**：小写字母 + 下划线，snake_case
- **前缀规范**：
  - 元数据表：`meta_` 前缀（如 `meta_file_batch`）
  - 原始数据表：`raw_` 前缀（如 `raw_booking_summary_rows`）
  - 维度表：`dim_` 前缀（如 `dim_store`）
  - 事实表：`fact_` 前缀（如 `fact_booking_summary`）
  - 聚合表：`agg_` 前缀（如 `agg_daily_store_summary`）

---

## 三、元数据表设计

### 3.1 文件批次表（meta_file_batch）

**用途**：记录每次文件导入的批次信息，用于追踪导入状态、支持重跑和审计。

**表结构设计**：

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 批次ID（代理键） |
| batch_no | VARCHAR(50) | UNIQUE, NOT NULL | 批次号（业务主键，格式：YYYYMMDD_HHMMSS_门店名_表类型） |
| file_path | VARCHAR(500) | NOT NULL | 原始文件路径（相对路径或绝对路径） |
| file_name | VARCHAR(255) | NOT NULL | 原始文件名 |
| file_size | BIGINT UNSIGNED | NOT NULL | 文件大小（字节） |
| file_checksum | VARCHAR(64) | NOT NULL | 文件校验和（SHA256） |
| table_type | VARCHAR(50) | NOT NULL | 表类型（booking_summary/beverage_sales/room_analysis） |
| store_name | VARCHAR(100) | NOT NULL | 门店名称（从文件名解析） |
| store_id | INT UNSIGNED | FOREIGN KEY | 关联门店维度表ID |
| date_range_start | DATE | NOT NULL | 数据时间范围起始日期 |
| date_range_end | DATE | NOT NULL | 数据时间范围结束日期 |
| import_status | VARCHAR(20) | NOT NULL | 导入状态（pending/processing/success/failed/partial） |
| total_rows | INT UNSIGNED | DEFAULT 0 | 总行数 |
| success_rows | INT UNSIGNED | DEFAULT 0 | 成功导入行数 |
| failed_rows | INT UNSIGNED | DEFAULT 0 | 失败行数 |
| error_message | TEXT | NULL | 错误信息（JSON格式，记录详细错误） |
| validation_report | JSON | NULL | 校验报告（JSON格式，记录平衡校验、异常检测结果） |
| created_by | VARCHAR(50) | NULL | 创建人（系统/用户名） |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |
| completed_at | TIMESTAMP | NULL | 完成时间 |

**索引设计**：
- 主键索引：`id`
- 唯一索引：`batch_no`
- 普通索引：`store_id`, `table_type`, `import_status`, `date_range_start`, `date_range_end`
- 复合索引：`(store_id, table_type, date_range_start)` 用于按门店、表类型、日期范围查询

**分区策略**：无需分区（数据量小，按时间范围查询即可）

### 3.2 字段映射表（meta_field_mapping）

**用途**：维护原列名到业务字段的映射关系，支持版本管理和动态映射。

**表结构设计**：

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | INT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 映射ID |
| table_type | VARCHAR(50) | NOT NULL | 表类型（booking_summary/beverage_sales/room_analysis） |
| original_column_name | VARCHAR(200) | NOT NULL | 原始列名（如"销售金额_Unnamed: 3_level_1"） |
| business_field_name | VARCHAR(100) | NOT NULL | 业务字段名（如"sales_amount"） |
| data_type | VARCHAR(50) | NOT NULL | 数据类型（DECIMAL(12,2)/VARCHAR(50)/INTEGER等） |
| is_required | BOOLEAN | DEFAULT FALSE | 是否必填 |
| description | TEXT | NULL | 字段说明 |
| calculation_formula | TEXT | NULL | 计算公式（如用于实收金额计算） |
| is_income_payment | BOOLEAN | DEFAULT FALSE | 是否收入类支付方式（用于实收计算） |
| is_cost_equity | BOOLEAN | DEFAULT FALSE | 是否成本/权益类支付方式（不计入实收） |
| version | VARCHAR(20) | NOT NULL, DEFAULT 'v1.0' | 映射版本号 |
| is_active | BOOLEAN | DEFAULT TRUE | 是否启用 |
| remarks | TEXT | NULL | 备注 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引设计**：
- 主键索引：`id`
- 唯一索引：`(table_type, original_column_name, version)` 确保同一表类型、同一原列名、同一版本只有一个映射
- 普通索引：`table_type`, `business_field_name`, `version`, `is_active`
- 复合索引：`(table_type, is_active, version)` 用于查询当前生效的映射

**分区策略**：无需分区

**数据初始化**：根据《字段映射.md》文档，初始化三张表的字段映射数据

### 3.3 导入日志表（meta_import_log）

**用途**：记录每次导入的详细操作日志，用于审计和问题排查。

**表结构设计**：

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 日志ID |
| batch_id | BIGINT UNSIGNED | FOREIGN KEY, NOT NULL | 关联文件批次表ID |
| log_level | VARCHAR(20) | NOT NULL | 日志级别（INFO/WARN/ERROR） |
| log_type | VARCHAR(50) | NOT NULL | 日志类型（parse/validate/import/aggregate等） |
| message | TEXT | NOT NULL | 日志消息 |
| details | JSON | NULL | 详细信息（JSON格式） |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引设计**：
- 主键索引：`id`
- 普通索引：`batch_id`, `log_level`, `log_type`, `created_at`
- 复合索引：`(batch_id, log_level, created_at)` 用于按批次查询错误日志

**分区策略**：按 `created_at` 按月分区（RANGE 分区），保留最近12个月数据

---

## 四、原始数据表设计

### 4.1 原始行表（raw_rows）

**用途**：存储清洗前的完整原始数据（JSON格式），用于审计、回滚、重新映射。

**表结构设计**：

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 行ID（代理键） |
| batch_id | BIGINT UNSIGNED | FOREIGN KEY, NOT NULL | 关联文件批次表ID |
| table_type | VARCHAR(50) | NOT NULL | 表类型（booking_summary/beverage_sales/room_analysis） |
| row_number | INT UNSIGNED | NOT NULL | 原始文件中的行号（从1开始，不含标题行） |
| row_hash | VARCHAR(64) | UNIQUE, NOT NULL | 行哈希值（SHA256，用于幂等性） |
| raw_json | JSON | NOT NULL | 原始行数据（JSON格式，包含所有原始列） |
| business_date | DATE | NULL | 营业日（从数据中解析，用于分区） |
| store_id | INT UNSIGNED | FOREIGN KEY, NULL | 关联门店维度表ID |
| is_valid | BOOLEAN | DEFAULT TRUE | 是否有效（校验通过） |
| validation_errors | JSON | NULL | 校验错误信息（JSON数组） |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引设计**：
- 主键索引：`id`
- 唯一索引：`row_hash` 确保幂等性
- 普通索引：`batch_id`, `table_type`, `business_date`, `store_id`, `is_valid`
- 复合索引：
  - `(batch_id, table_type)` 用于按批次和表类型查询
  - `(store_id, business_date, table_type)` 用于按门店、日期、表类型查询
  - `(business_date, is_valid)` 用于分区键和过滤条件

**分区策略**：
- **分区类型**：RANGE 分区
- **分区键**：`business_date`（营业日）
- **分区方案**：按月分区（如 `p202501`, `p202502` 等）
- **原因**：按营业日查询频繁，分区可提升查询性能；按月分区便于数据归档

**幂等性设计**：
- `row_hash` 字段使用 SHA256 算法计算：`SHA256(file_path + row_number + raw_json_content)`
- 插入前检查 `row_hash` 是否存在，存在则跳过或更新（根据策略）
- 支持同一文件重复导入而不产生重复数据

### 4.2 原始行表扩展说明

**JSON 字段结构示例**（以预订汇总表为例）：
```json
{
  "部门_Unnamed: 0_level_1": "销售经理",
  "订位人_Unnamed: 1_level_1": "申海宁",
  "订台数_Unnamed: 2_level_1": 5,
  "销售金额_Unnamed: 3_level_1": 1234.56,
  "支付方式_微信支付": 800.00,
  "支付方式_支付宝": 434.56
}
```

**优势**：
- 保留原始数据，支持后续字段映射变更
- 支持动态列（不同版本可能有不同列）
- 便于审计和问题排查

---

## 五、维度表设计

### 5.1 门店维度表（dim_store）

**用途**：存储门店基础信息，支持门店名称标准化和扩展属性。

**表结构设计**：

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | INT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 门店ID（代理键） |
| store_code | VARCHAR(50) | UNIQUE, NOT NULL | 门店编码（业务主键，如"STORE_001"） |
| store_name | VARCHAR(100) | NOT NULL | 门店名称（标准化后，如"空境·派对KTV（万象城店）"） |
| store_name_alias | JSON | NULL | 门店名称别名（JSON数组，用于文件名解析匹配） |
| region | VARCHAR(50) | NULL | 区域（如"万象城"、"青年路"） |
| city | VARCHAR(50) | NULL | 城市 |
| address | VARCHAR(255) | NULL | 地址 |
| contact_phone | VARCHAR(20) | NULL | 联系电话 |
| manager_name | VARCHAR(50) | NULL | 店长姓名 |
| is_active | BOOLEAN | DEFAULT TRUE | 是否启用 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引设计**：
- 主键索引：`id`
- 唯一索引：`store_code`, `store_name`
- 普通索引：`is_active`

**数据初始化**：根据样例文件中的门店名称，初始化门店维度数据

### 5.2 时间维度表（dim_date）

**用途**：存储日期维度信息，支持按日/周/月/季度/年度聚合。

**表结构设计**：

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| date | DATE | PRIMARY KEY | 日期（业务主键，格式：YYYY-MM-DD） |
| year | SMALLINT UNSIGNED | NOT NULL | 年份 |
| quarter | TINYINT UNSIGNED | NOT NULL | 季度（1-4） |
| month | TINYINT UNSIGNED | NOT NULL | 月份（1-12） |
| week | TINYINT UNSIGNED | NOT NULL | 周数（1-53） |
| day_of_month | TINYINT UNSIGNED | NOT NULL | 日（1-31） |
| day_of_week | TINYINT UNSIGNED | NOT NULL | 星期几（1=周一，7=周日） |
| is_weekend | BOOLEAN | NOT NULL | 是否周末 |
| is_holiday | BOOLEAN | DEFAULT FALSE | 是否节假日 |
| holiday_name | VARCHAR(50) | NULL | 节假日名称 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引设计**：
- 主键索引：`date`
- 普通索引：`year`, `quarter`, `month`, `week`, `is_weekend`, `is_holiday`

**数据初始化**：生成未来5年的日期维度数据（可扩展）

### 5.3 员工维度表（dim_employee）

**用途**：存储员工基础信息，支持员工姓名标准化和部门管理。

**表结构设计**：

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | INT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 员工ID（代理键） |
| employee_code | VARCHAR(50) | UNIQUE, NULL | 员工编码（业务主键，如有） |
| employee_name | VARCHAR(50) | NOT NULL | 员工姓名（标准化后） |
| employee_name_alias | JSON | NULL | 员工姓名别名（JSON数组，用于匹配） |
| department | VARCHAR(50) | NULL | 部门（销售经理/服务员/收银员等） |
| store_id | INT UNSIGNED | FOREIGN KEY, NULL | 关联门店维度表ID |
| position | VARCHAR(50) | NULL | 职位 |
| is_active | BOOLEAN | DEFAULT TRUE | 是否在职 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引设计**：
- 主键索引：`id`
- 唯一索引：`employee_code`（可为NULL）
- 普通索引：`employee_name`, `department`, `store_id`, `is_active`
- 复合索引：`(store_id, department, is_active)` 用于按门店、部门查询

### 5.4 包厢维度表（dim_room）

**用途**：存储包厢基础信息，支持包厢名称标准化和类型管理。

**表结构设计**：

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | INT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 包厢ID（代理键） |
| room_code | VARCHAR(50) | UNIQUE, NOT NULL | 包厢编码（业务主键，如"K01"） |
| room_name | VARCHAR(50) | NOT NULL | 包厢名称（标准化后，如"K01"） |
| room_name_alias | JSON | NULL | 包厢名称别名（JSON数组） |
| room_type | VARCHAR(50) | NULL | 包厢类型（电音中包/电音小包/电音大包/派对包等） |
| area_name | VARCHAR(50) | NULL | 区域名称（KTV区/派对包等） |
| store_id | INT UNSIGNED | FOREIGN KEY, NULL | 关联门店维度表ID |
| capacity | TINYINT UNSIGNED | NULL | 容纳人数 |
| is_active | BOOLEAN | DEFAULT TRUE | 是否启用 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引设计**：
- 主键索引：`id`
- 唯一索引：`room_code`
- 普通索引：`room_name`, `room_type`, `area_name`, `store_id`, `is_active`
- 复合索引：`(store_id, room_type, is_active)` 用于按门店、类型查询

### 5.5 商品维度表（dim_product）

**用途**：存储商品基础信息，支持商品名称标准化和分类管理。

**表结构设计**：

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | INT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 商品ID（代理键） |
| product_code | VARCHAR(50) | UNIQUE, NULL | 商品编码（业务主键，如有） |
| product_name | VARCHAR(100) | NOT NULL | 商品名称（标准化后） |
| product_name_alias | JSON | NULL | 商品名称别名（JSON数组） |
| category_name | VARCHAR(50) | NULL | 类别名称（Fashion小吃/主食/啤酒/饮料等） |
| unit | VARCHAR(20) | NULL | 计量单位（份/瓶/听/壶/包等） |
| area | VARCHAR(50) | NULL | 销售区域（KTV区/派对包等） |
| standard_price | DECIMAL(12,2) | NULL | 标准价格（元） |
| standard_cost | DECIMAL(12,2) | NULL | 标准成本（元） |
| is_active | BOOLEAN | DEFAULT TRUE | 是否启用 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引设计**：
- 主键索引：`id`
- 唯一索引：`product_code`（可为NULL）
- 普通索引：`product_name`, `category_name`, `unit`, `is_active`
- 复合索引：`(category_name, is_active)` 用于按类别查询

### 5.6 支付方式维度表（dim_payment_method）

**用途**：存储支付方式基础信息，支持支付方式分类（收入类/成本权益类）。

**表结构设计**：

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | TINYINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 支付方式ID（代理键） |
| payment_code | VARCHAR(50) | UNIQUE, NOT NULL | 支付方式编码（业务主键，如"wechat"） |
| payment_name | VARCHAR(50) | NOT NULL | 支付方式名称（如"微信支付"） |
| payment_name_alias | JSON | NULL | 支付方式名称别名（JSON数组） |
| payment_category | VARCHAR(20) | NOT NULL | 支付类别（income/cost_equity/unknown） |
| is_income | BOOLEAN | NOT NULL | 是否收入类支付（计入实收） |
| is_cost_equity | BOOLEAN | NOT NULL | 是否成本/权益类支付（不计入实收） |
| description | TEXT | NULL | 说明 |
| is_active | BOOLEAN | DEFAULT TRUE | 是否启用 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引设计**：
- 主键索引：`id`
- 唯一索引：`payment_code`
- 普通索引：`payment_name`, `payment_category`, `is_income`, `is_cost_equity`, `is_active`

**数据初始化**：根据《字段映射.md》中的支付方式列表，初始化支付方式维度数据

---

## 六、事实表设计

### 6.1 预订汇总事实表（fact_booking_summary）

**用途**：存储预订汇总表的业务数据，粒度=员工/门店/营业日。

**表结构设计**：

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 事实ID（代理键） |
| batch_id | BIGINT UNSIGNED | FOREIGN KEY, NOT NULL | 关联文件批次表ID |
| raw_row_id | BIGINT UNSIGNED | FOREIGN KEY, NULL | 关联原始行表ID（用于追溯） |
| business_date | DATE | NOT NULL | 营业日（分区键） |
| store_id | INT UNSIGNED | FOREIGN KEY, NOT NULL | 关联门店维度表ID |
| employee_id | INT UNSIGNED | FOREIGN KEY, NULL | 关联员工维度表ID（订位人） |
| department | VARCHAR(50) | NULL | 部门（冗余字段，便于查询） |
| booking_person | VARCHAR(50) | NULL | 订位人姓名（冗余字段，便于查询） |
| booking_count | INTEGER | NOT NULL, DEFAULT 0 | 订台数 |
| sales_amount | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 销售金额 |
| service_fee | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 服务费 |
| auto_deduction | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 自动扣减 |
| base_performance | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 基本业绩 |
| free_amount | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 免单金额 |
| credit_amount | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 挂账金额 |
| adjustment_amount | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 调整金额 |
| discount_amount | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 折扣金额 |
| round_off_amount | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 抹零金额 |
| gift_amount | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 赠送金额 |
| receivable_amount | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 应收金额 |
| actual_received | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 实收金额（核心指标） |
| payment_wechat | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 微信支付 |
| payment_alipay | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 支付宝 |
| payment_member | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 会员支付（含本金+赠送） |
| payment_member_principal | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 会员本金 |
| payment_member_gift | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 会员赠送 |
| payment_cash | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 现金 |
| payment_pos_card | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | POS机银行卡 |
| payment_waiter | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 服务员收款 |
| payment_employee_credit | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 员工信用扣款 |
| payment_fubei | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 付呗 |
| payment_groupon | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 团购 |
| payment_manager_sign | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 店长签单 |
| payment_performance_commission | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 演绎提成 |
| payment_douyin | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 抖音 |
| payment_pos | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | POS机 |
| payment_marketing_commission | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 营销提成 |
| payment_expired_wine | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 过期取酒 |
| payment_entertainment | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 招待 |
| payment_member_disabled | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 会员停用 |
| payment_triple_recharge | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 三倍充值活动 |
| payment_inter_account | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 往来款 |
| payment_gaode | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 高德 |
| beverage_expired_wine | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 酒水类别金额_过期取酒 |
| beverage_subtotal | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 酒水类别金额_小计 |
| row_hash | VARCHAR(64) | UNIQUE, NOT NULL | 行哈希值（用于幂等性） |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引设计**：
- 主键索引：`id`
- 唯一索引：`row_hash` 确保幂等性
- 普通索引：`batch_id`, `business_date`, `store_id`, `employee_id`, `department`, `booking_person`
- 复合索引：
  - `(store_id, business_date, employee_id)` 用于按门店、日期、员工查询
  - `(business_date, store_id)` 用于分区键和过滤条件
  - `(employee_id, business_date)` 用于员工业绩查询

**分区策略**：
- **分区类型**：RANGE 分区
- **分区键**：`business_date`（营业日）
- **分区方案**：按月分区（如 `p202501`, `p202502` 等）
- **原因**：按营业日查询频繁，分区可提升查询性能

**业务主键设计**：
- 业务主键：`(store_id, employee_id, business_date)` 的组合
- 但考虑到同一员工在同一天可能有多次记录（如不同部门），使用代理键 `id` 作为主键
- 通过 `row_hash` 确保同一原始行不会重复导入

### 6.2 包厢开台事实表（fact_room_analysis）

**用途**：存储包厢开台分析表的业务数据，粒度=开台单号/包厢/营业日。

**表结构设计**：

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 事实ID（代理键） |
| batch_id | BIGINT UNSIGNED | FOREIGN KEY, NOT NULL | 关联文件批次表ID |
| raw_row_id | BIGINT UNSIGNED | FOREIGN KEY, NULL | 关联原始行表ID |
| business_date | DATE | NOT NULL | 营业日（分区键） |
| store_id | INT UNSIGNED | FOREIGN KEY, NOT NULL | 关联门店维度表ID |
| room_id | INT UNSIGNED | FOREIGN KEY, NULL | 关联包厢维度表ID |
| room_name | VARCHAR(50) | NULL | 包厢名称（冗余字段） |
| room_type | VARCHAR(50) | NULL | 包厢类型（冗余字段） |
| area_name | VARCHAR(50) | NULL | 区域名称（冗余字段） |
| order_no | VARCHAR(50) | NOT NULL | 开台单号（业务主键，唯一标识） |
| billing_mode | VARCHAR(100) | NULL | 开房计费模式 |
| open_time | TIMESTAMP | NULL | 开房时间 |
| close_time | TIMESTAMP | NULL | 关房时间 |
| clean_time | TIMESTAMP | NULL | 清洁时间 |
| booking_person | VARCHAR(50) | NULL | 订房人姓名 |
| booking_department | VARCHAR(50) | NULL | 订房人部门 |
| return_person | VARCHAR(50) | NULL | 返房人姓名 |
| rotation_person | VARCHAR(50) | NULL | 轮房人姓名 |
| business_secretary | VARCHAR(50) | NULL | 商秘/外联 |
| duration_minutes | INTEGER | NULL | 消费时长（分钟） |
| time_period | VARCHAR(50) | NULL | 时段（黄金档/白天档/整档等） |
| room_tag | VARCHAR(50) | NULL | 开房标签 |
| booking_channel | VARCHAR(50) | NULL | 预订渠道 |
| bill_remark | TEXT | NULL | 账单备注 |
| bill_total | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 账单合计 |
| receivable_amount | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 应收金额 |
| actual_received | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 实收金额（核心指标） |
| gift_amount | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 赠送金额 |
| round_off_amount | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 抹零金额 |
| adjustment_amount | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 调整金额 |
| credit_amount | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 挂账金额 |
| free_amount | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 免单金额 |
| room_discount | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 房费折扣金额 |
| beverage_discount | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 酒水折扣金额 |
| base_performance | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 基本业绩 |
| min_consumption | DECIMAL(12,2) | NULL | 低消费金额 |
| min_consumption_diff | DECIMAL(12,2) | NULL | 低消差额 |
| included_min_consumption | DECIMAL(12,2) | NULL | 计入低消金额 |
| excluded_min_consumption | DECIMAL(12,2) | NULL | 不计入低消金额 |
| special_drink_amount | DECIMAL(12,2) | NULL | 特饮金额 |
| sales_manager | VARCHAR(50) | NULL | 销售经理 |
| marketing_manager | VARCHAR(50) | NULL | 营销经理 |
| payment_wechat | DECIMAL(12,2) | DEFAULT 0.00 | 微信支付 |
| payment_alipay | DECIMAL(12,2) | DEFAULT 0.00 | 支付宝 |
| payment_member | DECIMAL(12,2) | DEFAULT 0.00 | 会员支付 |
| payment_member_principal | DECIMAL(12,2) | DEFAULT 0.00 | 会员本金 |
| payment_member_gift | DECIMAL(12,2) | DEFAULT 0.00 | 会员赠送 |
| payment_cash | DECIMAL(12,2) | DEFAULT 0.00 | 现金 |
| payment_bank_card | DECIMAL(12,2) | DEFAULT 0.00 | 银行卡 |
| payment_waiter | DECIMAL(12,2) | DEFAULT 0.00 | 服务员收款 |
| payment_employee_credit | DECIMAL(12,2) | DEFAULT 0.00 | 员工信用扣款 |
| payment_fubei | DECIMAL(12,2) | DEFAULT 0.00 | 付呗 |
| payment_manager_sign | DECIMAL(12,2) | DEFAULT 0.00 | 店长签单 |
| payment_performance_commission | DECIMAL(12,2) | DEFAULT 0.00 | 演绎提成 |
| payment_marketing_commission | DECIMAL(12,2) | DEFAULT 0.00 | 营销提成 |
| payment_expired_wine | DECIMAL(12,2) | DEFAULT 0.00 | 过期取酒 |
| payment_meituan | DECIMAL(12,2) | DEFAULT 0.00 | 美团 |
| payment_douyin | DECIMAL(12,2) | DEFAULT 0.00 | 抖音 |
| payment_entertainment | DECIMAL(12,2) | DEFAULT 0.00 | 招待 |
| payment_scan | DECIMAL(12,2) | DEFAULT 0.00 | 扫码 |
| payment_member_disabled | DECIMAL(12,2) | DEFAULT 0.00 | 会员停用 |
| payment_triple_recharge | DECIMAL(12,2) | DEFAULT 0.00 | 三倍储值活动 |
| payment_deposit | DECIMAL(12,2) | DEFAULT 0.00 | 定金消费 |
| payment_gaode | DECIMAL(12,2) | DEFAULT 0.00 | 高德 |
| row_hash | VARCHAR(64) | UNIQUE, NOT NULL | 行哈希值（用于幂等性） |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引设计**：
- 主键索引：`id`
- 唯一索引：`order_no`（业务主键，开台单号唯一），`row_hash`（幂等性）
- 普通索引：`batch_id`, `business_date`, `store_id`, `room_id`, `room_name`, `open_time`, `close_time`
- 复合索引：
  - `(store_id, business_date, room_id)` 用于按门店、日期、包厢查询
  - `(business_date, store_id)` 用于分区键和过滤条件
  - `(order_no, business_date)` 用于按开台单号查询
  - `(open_time, close_time)` 用于时间范围查询

**分区策略**：
- **分区类型**：RANGE 分区
- **分区键**：`business_date`（营业日）
- **分区方案**：按月分区（如 `p202501`, `p202502` 等）

**业务主键设计**：
- 业务主键：`order_no`（开台单号）唯一标识一条开台记录
- 使用代理键 `id` 作为主键，`order_no` 作为唯一索引

### 6.3 酒水销售事实表（fact_beverage_sales）

**用途**：存储酒水销售分析表的业务数据，粒度=商品/门店/营业日。

**表结构设计**：

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|---------|------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 事实ID（代理键） |
| batch_id | BIGINT UNSIGNED | FOREIGN KEY, NOT NULL | 关联文件批次表ID |
| raw_row_id | BIGINT UNSIGNED | FOREIGN KEY, NULL | 关联原始行表ID |
| business_date | DATE | NOT NULL | 营业日（分区键） |
| store_id | INT UNSIGNED | FOREIGN KEY, NOT NULL | 关联门店维度表ID |
| product_id | INT UNSIGNED | FOREIGN KEY, NULL | 关联商品维度表ID |
| beverage_name | VARCHAR(100) | NULL | 酒水名称（冗余字段） |
| category_name | VARCHAR(50) | NULL | 类别名称（冗余字段） |
| unit | VARCHAR(20) | NULL | 单位（冗余字段） |
| area | VARCHAR(50) | NULL | 区域（冗余字段） |
| cost_total | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 成本小计 |
| cost_sales | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 成本_销售 |
| cost_gift | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 成本_赠送 |
| profit | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 利润 |
| profit_rate | DECIMAL(8,2) | NULL | 利润率（百分比数值，如4700表示47%） |
| total_quantity | INTEGER | NOT NULL, DEFAULT 0 | 合计数量 |
| total_amount | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 合计金额 |
| sales_qty_total | INTEGER | NOT NULL, DEFAULT 0 | 销售数量小计 |
| sales_qty_sales | INTEGER | NOT NULL, DEFAULT 0 | 销售数量_销售 |
| sales_qty_combo | INTEGER | NOT NULL, DEFAULT 0 | 销售数量_套餐子物品 |
| sales_qty_free_combo | INTEGER | NOT NULL, DEFAULT 0 | 销售数量_例送子物品 |
| sales_amount_total | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 销售金额小计（折后） |
| sales_amount_sales | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 销售金额_销售 |
| sales_amount_combo | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 销售金额_套餐子物品 |
| sales_amount_free_combo | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 销售金额_例送子物品 |
| gift_qty_total | INTEGER | NOT NULL, DEFAULT 0 | 赠送数量小计 |
| gift_qty_gift | INTEGER | NOT NULL, DEFAULT 0 | 赠送数量_赠送 |
| gift_qty_combo | INTEGER | NOT NULL, DEFAULT 0 | 赠送数量_套餐子物品 |
| gift_amount_total | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 赠送金额小计 |
| gift_amount_gift | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 赠送金额_赠送 |
| gift_amount_combo | DECIMAL(12,2) | NOT NULL, DEFAULT 0.00 | 赠送金额_套餐子物品 |
| row_hash | VARCHAR(64) | UNIQUE, NOT NULL | 行哈希值（用于幂等性） |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引设计**：
- 主键索引：`id`
- 唯一索引：`row_hash` 确保幂等性
- 普通索引：`batch_id`, `business_date`, `store_id`, `product_id`, `beverage_name`, `category_name`
- 复合索引：
  - `(store_id, business_date, product_id)` 用于按门店、日期、商品查询
  - `(business_date, store_id)` 用于分区键和过滤条件
  - `(category_name, business_date)` 用于按类别查询

**分区策略**：
- **分区类型**：RANGE 分区
- **分区键**：`business_date`（营业日）
- **分区方案**：按月分区（如 `p202501`, `p202502` 等）

**业务主键设计**：
- 业务主键：`(store_id, product_id, business_date)` 的组合
- 使用代理键 `id` 作为主键
- 通过 `row_hash` 确保同一原始行不会重复导入

---

## 七、主键设计策略

### 7.1 主键类型选择

**代理键 vs 业务主键**：

1. **代理键（AUTO_INCREMENT）**：
   - **优势**：性能好（整数类型，索引效率高）、稳定（不受业务规则变更影响）、简单（无需复合主键）
   - **使用场景**：所有事实表和大部分维度表

2. **业务主键**：
   - **优势**：语义清晰、便于业务查询
   - **使用场景**：
     - 时间维度表：`date`（DATE类型）作为主键
     - 包厢开台事实表：`order_no`（开台单号）作为唯一索引（业务主键）

### 7.2 主键设计原则

1. **事实表**：使用 `BIGINT UNSIGNED AUTO_INCREMENT` 作为主键，业务主键通过唯一索引保证
2. **维度表**：使用 `INT UNSIGNED AUTO_INCREMENT` 或业务主键（如时间维度表）
3. **元数据表**：使用 `BIGINT UNSIGNED AUTO_INCREMENT` 或 `INT UNSIGNED AUTO_INCREMENT`

### 7.3 业务主键+营业日组合

对于需要按营业日分区的表，业务主键设计考虑：

- **预订汇总事实表**：理论上 `(store_id, employee_id, business_date)` 可作为业务主键，但考虑到同一员工在同一天可能有多次记录，使用代理键+唯一索引 `row_hash`
- **包厢开台事实表**：`order_no`（开台单号）作为业务主键，唯一标识一条记录
- **酒水销售事实表**：理论上 `(store_id, product_id, business_date)` 可作为业务主键，但考虑到同一商品在同一天可能有多次记录，使用代理键+唯一索引 `row_hash`

---

## 八、分区策略设计

### 8.1 分区类型选择

**MySQL 支持的分区类型**：
- **RANGE 分区**：按范围分区（如按日期范围）
- **LIST 分区**：按列表值分区（如按门店列表）
- **HASH 分区**：按哈希值分区（均匀分布）
- **KEY 分区**：类似 HASH，但使用 MySQL 内置哈希函数

**选择 RANGE 分区的原因**：
- 按营业日查询频繁，RANGE 分区可按日期范围快速定位分区
- 便于数据归档（删除旧分区）
- 便于维护（按分区备份、恢复）

### 8.2 分区键选择

**分区键**：`business_date`（营业日，DATE类型）

**原因**：
- 查询场景主要是按日期范围查询（如查询某月、某周的数据）
- 分区裁剪可大幅提升查询性能
- 便于数据归档（删除旧月份分区）

### 8.3 分区方案

**按月分区**：
- 分区命名：`p202501`（2025年1月）、`p202502`（2025年2月）等
- 分区范围：每月1日到月末
- 示例分区定义：
  ```
  PARTITION p202501 VALUES LESS THAN ('2025-02-01'),
  PARTITION p202502 VALUES LESS THAN ('2025-03-01'),
  PARTITION p202503 VALUES LESS THAN ('2025-04-01'),
  ...
  ```

**需要分区的表**：
- `raw_rows`（原始行表）
- `fact_booking_summary`（预订汇总事实表）
- `fact_room_analysis`（包厢开台事实表）
- `fact_beverage_sales`（酒水销售事实表）
- `meta_import_log`（导入日志表，按月分区）

**不需要分区的表**：
- 维度表（数据量小）
- 元数据表（除导入日志表外，数据量小）

### 8.4 分区维护

**自动创建分区**：
- 每月初自动创建下个月的分区
- 可通过定时任务（如 APScheduler）或存储过程实现

**分区归档**：
- 保留最近12-24个月的数据
- 超过保留期的分区可归档到历史表或删除

**分区监控**：
- 监控分区数据量，避免单个分区过大（建议单分区不超过1000万行）
- 如数据量过大，可考虑按周分区或按季度分区

---

## 九、索引设计策略

### 9.1 索引类型

**主键索引**：所有表都有主键索引（自动创建）

**唯一索引**：
- `meta_file_batch.batch_no`：批次号唯一
- `raw_rows.row_hash`：行哈希唯一（幂等性）
- `fact_booking_summary.row_hash`：行哈希唯一
- `fact_room_analysis.order_no`：开台单号唯一
- `fact_room_analysis.row_hash`：行哈希唯一
- `fact_beverage_sales.row_hash`：行哈希唯一
- `dim_store.store_code`：门店编码唯一
- `dim_employee.employee_code`：员工编码唯一（可为NULL）
- `dim_room.room_code`：包厢编码唯一
- `dim_product.product_code`：商品编码唯一（可为NULL）
- `dim_payment_method.payment_code`：支付方式编码唯一

**普通索引**：
- 外键字段（如 `store_id`, `employee_id`, `room_id`, `product_id`）
- 常用查询字段（如 `business_date`, `table_type`, `import_status`）
- 时间字段（如 `open_time`, `close_time`, `created_at`）

**复合索引**：
- 按查询场景设计，如 `(store_id, business_date, employee_id)` 用于按门店、日期、员工查询
- 包含分区键的复合索引，如 `(business_date, store_id)` 用于分区裁剪和过滤

### 9.2 索引设计原则

1. **外键索引**：所有外键字段都创建索引（提升 JOIN 性能）
2. **查询字段索引**：根据常用查询场景创建索引
3. **复合索引顺序**：将选择性高的字段放在前面，分区键放在前面（便于分区裁剪）
4. **避免过度索引**：索引过多会影响写入性能，需要平衡查询和写入性能

### 9.3 索引维护

**定期分析**：
- 使用 `EXPLAIN` 分析查询计划，优化索引
- 监控慢查询日志，识别缺失索引

**索引重建**：
- 定期重建索引（如按月），提升查询性能
- 使用 `OPTIMIZE TABLE` 或 `ALTER TABLE ... REBUILD PARTITION`

---

## 十、幂等性设计

### 10.1 幂等性需求

**场景**：
- 同一文件重复导入不应产生重复数据
- 支持重跑失败批次而不产生重复数据
- 支持部分成功、部分失败的场景

### 10.2 幂等性实现方案

**方案：行哈希唯一约束**

1. **行哈希计算**：
   - 算法：SHA256
   - 输入：`file_path + row_number + raw_json_content`（原始行JSON字符串）
   - 输出：64位十六进制字符串

2. **唯一约束**：
   - 在 `raw_rows.row_hash` 字段创建唯一索引
   - 在事实表的 `row_hash` 字段创建唯一索引

3. **插入策略**：
   - **INSERT IGNORE**：如果 `row_hash` 已存在，忽略插入（不报错）
   - **INSERT ... ON DUPLICATE KEY UPDATE**：如果 `row_hash` 已存在，更新记录（用于覆盖策略）
   - **先查询后插入**：先查询 `row_hash` 是否存在，不存在才插入（用于追加策略）

4. **批次去重**：
   - 在文件批次表中记录 `file_checksum`（文件校验和），用于检测文件是否已导入
   - 支持按批次号重跑（删除该批次数据后重新导入）

### 10.3 幂等性策略选择

**推荐策略**：**INSERT IGNORE**（忽略重复）

**原因**：
- 简单高效，数据库层面保证唯一性
- 适合追加场景（同一文件重复导入时自动跳过）
- 不影响已存在数据的完整性

**其他策略**：
- **覆盖策略**：使用 `INSERT ... ON DUPLICATE KEY UPDATE`，适用于需要更新数据的场景
- **追加策略**：先查询后插入，适用于需要记录每次导入历史的场景

### 10.4 幂等性测试

**测试场景**：
1. 同一文件重复导入，验证不产生重复数据
2. 部分成功、部分失败的批次重跑，验证幂等性
3. 不同文件但内容相同的行，验证哈希唯一性

---

## 十一、SQLAlchemy 模型设计

### 11.1 模型设计原则

**设计原则**：
- 使用 SQLAlchemy ORM 定义模型，便于代码维护和类型检查
- 避免使用 `any` 类型，明确指定字段类型
- 函数单一职责，模型类只负责数据定义
- 使用 Alembic 进行数据库迁移管理

### 11.2 模型文件组织

**建议的文件结构**：
```
models/
├── __init__.py          # 导出所有模型
├── base.py              # 基础模型类（包含公共字段）
├── meta.py              # 元数据表模型
├── raw.py               # 原始数据表模型
├── dim.py               # 维度表模型
├── fact.py              # 事实表模型
└── agg.py               # 聚合表模型（可选）
```

### 11.3 基础模型类

**base.py**：定义公共字段和基类
- `id`：主键字段
- `created_at`：创建时间
- `updated_at`：更新时间
- `Base`：SQLAlchemy 基类

### 11.4 模型设计要点

**字段类型映射**：
- `DECIMAL(12,2)` → `Numeric(12, 2)`
- `VARCHAR(n)` → `String(n)`
- `JSON` → `JSON`（MySQL 5.7+）
- `DATE` → `Date`
- `TIMESTAMP` → `DateTime`
- `BOOLEAN` → `Boolean`

**关系定义**：
- 使用 `relationship()` 定义外键关系
- 使用 `ForeignKey()` 定义外键约束
- 使用 `backref` 定义反向关系

**索引定义**：
- 使用 `Index()` 定义普通索引
- 使用 `UniqueConstraint()` 定义唯一索引
- 使用 `__table_args__` 定义复合索引和分区

### 11.5 分区定义

**MySQL 分区在 SQLAlchemy 中的处理**：
- SQLAlchemy 不直接支持分区语法
- 需要在 Alembic 迁移脚本中使用原始 SQL 定义分区
- 模型定义中不包含分区信息，分区在 DDL 中定义

---

## 十二、Alembic 迁移管理

### 12.1 Alembic 初始化

**初始化步骤**：
1. 安装 Alembic：`pip install alembic`
2. 初始化：`alembic init alembic`
3. 配置 `alembic.ini` 中的数据库连接
4. 配置 `alembic/env.py` 中的模型导入

### 12.2 迁移脚本生成

**生成迁移脚本**：
- 自动生成：`alembic revision --autogenerate -m "描述"`
- 手动创建：`alembic revision -m "描述"`

**迁移脚本内容**：
- `upgrade()`：执行迁移（创建表、添加字段等）
- `downgrade()`：回滚迁移（删除表、删除字段等）

### 12.3 分区定义迁移

**分区定义示例**（在迁移脚本中）：
```python
def upgrade():
    # 创建表结构
    op.create_table(...)
    
    # 使用原始 SQL 定义分区
    op.execute("""
        ALTER TABLE fact_booking_summary
        PARTITION BY RANGE (TO_DAYS(business_date)) (
            PARTITION p202501 VALUES LESS THAN (TO_DAYS('2025-02-01')),
            PARTITION p202502 VALUES LESS THAN (TO_DAYS('2025-03-01')),
            PARTITION p202503 VALUES LESS THAN (TO_DAYS('2025-04-01'))
        )
    """)
```

### 12.4 迁移执行

**执行迁移**：
- 升级到最新版本：`alembic upgrade head`
- 升级到指定版本：`alembic upgrade <revision>`
- 回滚到上一版本：`alembic downgrade -1`
- 查看当前版本：`alembic current`
- 查看历史：`alembic history`

### 12.5 迁移最佳实践

**版本管理**：
- 每次数据库结构变更都创建新的迁移脚本
- 迁移脚本命名清晰，描述变更内容
- 迁移脚本可回滚，确保 `downgrade()` 正确实现

**数据迁移**：
- 结构变更和数据迁移分开处理
- 大表结构变更时考虑在线 DDL（MySQL 5.6+）
- 数据迁移使用批量处理，避免锁表

---

## 十三、实施步骤与方法

### 13.1 数据库环境准备

**步骤**：
1. 安装 MySQL 5.7+ 或 MySQL 8.0+
2. 创建数据库和用户：
   - 创建数据库：`CREATE DATABASE ktv_report CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;`
   - 创建用户并授权：`GRANT ALL PRIVILEGES ON ktv_report.* TO 'ktv_user'@'%';`
3. 配置数据库连接参数（host、port、user、password、database）

### 13.2 表结构创建顺序

**建议的创建顺序**：
1. **维度表**（无依赖）：
   - `dim_date`（时间维度表，可预生成数据）
   - `dim_store`（门店维度表）
   - `dim_payment_method`（支付方式维度表）
   - `dim_employee`（员工维度表）
   - `dim_room`（包厢维度表）
   - `dim_product`（商品维度表）

2. **元数据表**（无依赖）：
   - `meta_field_mapping`（字段映射表，需初始化数据）
   - `meta_file_batch`（文件批次表）
   - `meta_import_log`（导入日志表）

3. **原始数据表**（依赖元数据表）：
   - `raw_rows`（原始行表）

4. **事实表**（依赖维度表和原始数据表）：
   - `fact_booking_summary`（预订汇总事实表）
   - `fact_room_analysis`（包厢开台事实表）
   - `fact_beverage_sales`（酒水销售事实表）

### 13.3 初始化数据准备

**维度表初始化**：
1. **时间维度表**：生成未来5年的日期数据（年、季度、月、周、日等）
2. **门店维度表**：根据样例文件中的门店名称，初始化门店数据
3. **支付方式维度表**：根据《字段映射.md》中的支付方式列表，初始化支付方式数据
4. **字段映射表**：根据《字段映射.md》文档，初始化三张表的字段映射数据

### 13.4 分区创建策略

**初始分区创建**：
- 创建当前月份及未来3个月的分区
- 示例：如果当前是2025年12月，创建 `p202512`、`p202601`、`p202602`、`p202603` 分区

**分区自动创建**：
- 使用定时任务（如 APScheduler）每月初自动创建下个月的分区
- 或使用存储过程，在插入数据前检查分区是否存在，不存在则创建

### 13.5 索引创建策略

**索引创建时机**：
- 表创建后立即创建索引（对于小表）
- 对于大表，可以先导入数据，再创建索引（提升导入性能）

**索引创建顺序**：
1. 主键索引（自动创建）
2. 唯一索引（确保数据完整性）
3. 外键索引（提升 JOIN 性能）
4. 普通索引和复合索引（根据查询场景）

### 13.6 数据导入流程

**导入流程**：
1. **文件解析**：读取文件，删除标题行，生成行哈希
2. **字段映射**：根据字段映射表，将原列名映射为业务字段名
3. **数据清洗**：类型转换、缺失值填充、数据标准化
4. **数据校验**：平衡校验、异常检测
5. **维度关联**：关联维度表，获取维度ID
6. **批次记录**：创建文件批次记录
7. **原始数据入库**：写入 `raw_rows` 表
8. **事实数据入库**：写入对应的事实表
9. **更新批次状态**：更新文件批次表的导入状态和统计信息
10. **生成校验报告**：生成校验报告并记录到批次表

### 13.7 性能优化建议

**导入性能优化**：
1. **批量插入**：使用 `bulk_insert_mappings()` 或 `INSERT ... VALUES (...), (...), (...)` 批量插入
2. **事务控制**：每批次使用一个事务，失败时回滚
3. **索引优化**：导入时临时禁用非唯一索引，导入完成后重建
4. **分区裁剪**：按分区插入数据，利用分区裁剪提升性能

**查询性能优化**：
1. **分区裁剪**：查询时使用分区键过滤，利用分区裁剪
2. **索引优化**：根据慢查询日志，优化缺失的索引
3. **查询缓存**：对于不经常变更的维度表，使用查询缓存
4. **物化视图**：MySQL 8.0+ 使用物化视图提升聚合查询性能

### 13.8 监控与维护

**监控指标**：
1. **数据量监控**：监控各表的数据量增长
2. **分区监控**：监控分区数据量，避免单个分区过大
3. **索引监控**：监控索引使用情况，识别未使用的索引
4. **性能监控**：监控慢查询，优化查询性能

**维护任务**：
1. **分区维护**：每月初创建新分区，定期归档旧分区
2. **索引维护**：定期重建索引，优化查询性能
3. **数据归档**：定期归档历史数据，释放存储空间
4. **备份恢复**：定期备份数据库，测试恢复流程

---

## 十四、总结与后续工作

### 14.1 设计总结

**核心设计要点**：
1. **数据库选型**：MySQL 5.7+（推荐 8.0+），支持 JSON 类型和分区功能
2. **表结构设计**：元数据表、原始数据表、维度表、事实表分层设计
3. **主键策略**：代理键 + 业务主键（唯一索引）组合
4. **分区策略**：按营业日 RANGE 分区，按月分区
5. **索引设计**：主键索引、唯一索引、外键索引、复合索引
6. **幂等性设计**：行哈希唯一约束，支持重复导入

### 14.2 后续工作

**实施阶段**：
1. **第一阶段**：创建数据库和表结构，初始化维度表和字段映射表
2. **第二阶段**：实现数据导入流程，支持单文件导入和批量导入
3. **第三阶段**：实现数据校验和告警，生成校验报告
4. **第四阶段**：实现聚合查询和报表，支持多维度分析
5. **第五阶段**：性能优化和监控，完善运维体系

**优化方向**：
1. **查询优化**：根据实际查询场景，优化索引和分区策略
2. **存储优化**：根据数据量增长，调整分区策略和归档策略
3. **功能扩展**：支持更多表类型，扩展分析维度

---

## 附录

### A. 表结构清单

**元数据表**（3张）：
- `meta_file_batch`：文件批次表
- `meta_field_mapping`：字段映射表
- `meta_import_log`：导入日志表

**原始数据表**（1张）：
- `raw_rows`：原始行表

**维度表**（6张）：
- `dim_store`：门店维度表
- `dim_date`：时间维度表
- `dim_employee`：员工维度表
- `dim_room`：包厢维度表
- `dim_product`：商品维度表
- `dim_payment_method`：支付方式维度表

**事实表**（3张）：
- `fact_booking_summary`：预订汇总事实表
- `fact_room_analysis`：包厢开台事实表
- `fact_beverage_sales`：酒水销售事实表

**总计**：13张表

### B. 参考文档

- 《具体需求.md》：业务需求说明
- 《字段映射.md》：字段映射规范
- 《详细业务分析实现.md》：技术实施方案
- 《各张表字段.md》：原始字段说明

### C. 版本历史

- **v1.0**（2025-12-03）：初始版本，完成入库模型设计文档

---

**文档结束**